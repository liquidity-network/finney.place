"use strict";var __extends=this&&this.__extends||function(){var n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])};return function(e,t){function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var bignumber_js_1=__importDefault(require("bignumber.js")),hashable_model_1=require("../primitives/hashable.model"),signature_model_1=require("../primitives/signature.model"),util_1=require("../../util"),logging_1=require("../../services/logging"),transfer_active_state_update_type_model_1=require("./transfer-active-state-update-type.model"),Transfer=function(h){function i(e,t,i,n,r,s,a,o,u,l,p,d,_,c,f){void 0===c&&(c=null),void 0===f&&(f=!1);var b=h.call(this)||this;return b._tokenAddress=e,b._address=t,b._eonNumber=i,b._amount=n,b._amountSwapped=r,b._startingBalance=s,b._recipientTokenAddress=a,b._recipient=o,b._recipientTrailIdentifier=u,b._target=l,b._nonce=p,b._txId=d,b._isPassive=_,b._passiveOffset=c,b._isPassiveFinalized=f,b._authorizations=new Map,b._confirmations=new Map,b._amount=new bignumber_js_1.default(n),void 0===p&&(b._nonce=new bignumber_js_1.default(Math.floor(1e8+899999999*Math.random()))),b}return __extends(i,h),i.fromJSON=function(e){var t=new i(e.tokenAddress,e.address,e.eonNumber,new bignumber_js_1.default(e.amount),e.amountSwapped?new bignumber_js_1.default(e.amountSwapped):null,e.startingBalance?new bignumber_js_1.default(e.startingBalance):null,e.recipientTokenAddress,e.recipient,e.recipientTrailIdentifier,e.target,new bignumber_js_1.default(e.nonce),e.txId,e.isPassive,e.passiveOffset?new bignumber_js_1.default(e.passiveOffset):null,e.isPassiveFinalized);return t._authorizations=new Map(util_1.JSONbig.parse(e.authorizations)),t._confirmations=new Map(util_1.JSONbig.parse(e.confirmations).map(function(e){return[e[0],signature_model_1.Signature.fromJSON(e[1])]})),t._deliveryProof=e.deliveryProof,t._amountsMatched=e.amountsMatched,t},i.checksumTransfer=function(e,t,i,n,r,s){if(r){var a=s||new bignumber_js_1.default(2).pow(256).minus(1);n=new bignumber_js_1.default(util_1.remove0xPrefix(util_1.Web3Utils.soliditySha3({type:"uint256",value:a.toFixed(0)},{type:"uint256",value:n.toFixed(0)}).toString()),16)}return util_1.Web3Utils.soliditySha3({type:"bytes32",value:util_1.Web3Utils.soliditySha3({type:"address",value:e})},{type:"uint256",value:t.toFixed(0)},{type:"uint64",value:i},{type:"uint256",value:n.toFixed(0)}).toString()},i.checksumSwap=function(e,t,i,n,r,s,a){return util_1.Web3Utils.soliditySha3({type:"bytes32",value:util_1.Web3Utils.soliditySha3({type:"address",value:e})},{type:"bytes32",value:util_1.Web3Utils.soliditySha3({type:"address",value:t})},{type:"uint64",value:i},{type:"uint256",value:n.toFixed(0)},{type:"uint256",value:r.toFixed(0)},{type:"uint256",value:s.toFixed(0)},{type:"uint256",value:a.toFixed(0)}).toString()},i.checksumSwapFreeze=function(e,t,i){return util_1.Web3Utils.soliditySha3({type:"bytes32",value:util_1.Web3Utils.soliditySha3({type:"address",value:e})},{type:"bytes32",value:util_1.Web3Utils.soliditySha3({type:"address",value:t})},{type:"uint256",value:i.toFixed(0)}).toString()},Object.defineProperty(i.prototype,"json",{get:function(){return{tokenAddress:this._tokenAddress,address:this._address,eonNumber:this._eonNumber,amount:this._amount.toFixed(0),amountSwapped:this._amountSwapped?this._amountSwapped.toFixed(0):null,startingBalance:this._startingBalance?this._startingBalance.toFixed(0):null,recipientTokenAddress:this._recipientTokenAddress,recipient:this._recipient,recipientTrailIdentifier:this._recipientTrailIdentifier,target:this._target,nonce:this._nonce.toFixed(0),txId:this._txId,authorizations:util_1.JSONbig.stringify(Array.from(this._authorizations.entries())),confirmations:util_1.JSONbig.stringify(Array.from(this._confirmations.entries()).map(function(e){return[e[0],e[1].json]})),deliveryProof:this._deliveryProof,amountsMatched:this._amountsMatched,isPassive:this._isPassive,passiveOffset:this._passiveOffset?this._passiveOffset.toFixed(0):null,isPassiveFinalized:this._isPassiveFinalized}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSwap",{get:function(){return null!=this.amountSwapped&&null!=this.amountSwapped},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSwapActive",{get:function(){var e=this.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),t=this.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT);return this.isSwap&&null!=e&&null!=e&&null!=t&&null!=t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSwapFulfilled",{get:function(){var e=this.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT);return this.isSwap&&null!=e&&null!=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSwapFrozen",{get:function(){var e=this.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FREEZING);return this.isSwap&&null!=e&&null!=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSwapCancelled",{get:function(){var e=this.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION);return this.isSwap&&null!=e&&null!=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isSwapFinalized",{get:function(){var e=this.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FINALIZATION);return this.isSwap&&null!=e&&null!=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"txId",{get:function(){return this._txId},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isPassive",{get:function(){return this._isPassive},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"passiveOffset",{get:function(){return this._passiveOffset},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"hash",{get:function(){return this===i.PADDING_TRANSFER?"0x0000000000000000000000000000000000000000000000000000000000000000":this.isSwap?util_1.isSameHexValue(this._tokenAddress,this._target)&&(this.isSwapFulfilled||this.isSwapFinalized||this.isSwapFrozen||this.isSwapCancelled)?i.checksumSwap(this._tokenAddress,this._recipientTokenAddress,this.recipientTrailIdentifier,this.amount,this.amountSwapped,i.FULFILLED_SWAP_MARKER,this.nonce):i.checksumSwap(this._tokenAddress,this._recipientTokenAddress,this.recipientTrailIdentifier,this.amount,this.amountSwapped,this.startingBalance,this.nonce):i.checksumTransfer(this._target,this._amount,this._recipientTrailIdentifier,this._nonce,this._isPassive,this.isPassive&&this._isPassiveFinalized?this._passiveOffset:null)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"cancellationHash",{get:function(){return i.checksumSwapFreeze(this.tokenAddress,this.recipientTokenAddress,this.nonce)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"tokenAddress",{get:function(){return this._tokenAddress},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"recipientTokenAddress",{get:function(){return this._recipientTokenAddress},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"startingBalance",{get:function(){return this._startingBalance},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"sender",{get:function(){return this._address},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"eonNumber",{get:function(){return this._eonNumber},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"amount",{get:function(){return this._amount},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"amountSwapped",{get:function(){return this._amountSwapped},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"recipient",{get:function(){return this._recipient},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"recipientTrailIdentifier",{get:function(){return this._recipientTrailIdentifier},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"nonce",{get:function(){return this._nonce},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"confirmations",{get:function(){return this._confirmations},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"authorizations",{get:function(){return this._authorizations},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"deliveryProof",{get:function(){return this._deliveryProof},enumerable:!0,configurable:!0}),i.prototype.saveDeliveryProof=function(e){return this._deliveryProof?logging_1.Logging.error("saveDeliveryProof repetition"):this._deliveryProof=e,this},Object.defineProperty(i.prototype,"amountsMatched",{get:function(){return this._amountsMatched},set:function(e){this._amountsMatched=e},enumerable:!0,configurable:!0}),i.prototype.finalizePassive=function(){this.isPassive&&this._passiveOffset&&(this._isPassiveFinalized=!0)},i.PADDING_TRANSFER=new i("0x0000000000000000000000000000000000000000","0x0000000000000000000000000000000000000000",0,new bignumber_js_1.default(0),new bignumber_js_1.default(0),new bignumber_js_1.default(0),"0x0000000000000000000000000000000000000000","0x0000000000000000000000000000000000000000",0,"0x0000000000000000000000000000000000000000",new bignumber_js_1.default(0),0,!1),i.FULFILLED_SWAP_MARKER=new bignumber_js_1.default(2).pow(256).minus(1),i}(hashable_model_1.Hashable);exports.Transfer=Transfer;