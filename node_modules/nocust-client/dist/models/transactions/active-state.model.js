"use strict";var __extends=this&&this.__extends||function(){var r=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])};return function(e,t){function n(){this.constructor=e}r(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}}(),__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var bignumber_js_1=__importDefault(require("bignumber.js")),transfer_model_1=require("./transfer.model"),merkle_tree_model_1=require("../primitives/merkle-tree.model"),hashable_model_1=require("../primitives/hashable.model"),util_1=require("../../util"),transfer_active_state_update_type_model_1=require("./transfer-active-state-update-type.model"),logging_1=require("../../services/logging"),ActiveState=function(a){function n(e,t,n,r,i){var s=a.call(this)||this;return s._contractAddress=e,s._tokenAddress=t,s._walletAddress=n,s._trailIdentifier=r,s._eonNumber=i,s._transfers=[],s._pendingTransfer=null,s._spent=new bignumber_js_1.default("0"),s._gained=new bignumber_js_1.default("0"),s._passivelyGained=new bignumber_js_1.default("0"),s._pendingReceipt=new bignumber_js_1.default("0"),s.recalculateTransactionTree(),s}return __extends(n,a),n.fromJSON=function(e){var t=new n(e.contractAddress,e.tokenAddress,e.walletAddress,e.trailIdentifier,e.eonNumber);return t._transfers=e.transfers.map(function(e){return transfer_model_1.Transfer.fromJSON(e)}),t._pendingTransfer=null==e.pendingTransfer?null:transfer_model_1.Transfer.fromJSON(e.pendingTransfer),t._spent=new bignumber_js_1.default(e.spent),t._gained=new bignumber_js_1.default(e.gained),t._passivelyGained=new bignumber_js_1.default(e.passivelyGained),t._pendingReceipt=new bignumber_js_1.default(e.pendingReceipt),t.recalculateTransactionTree(),t},n.checksum=function(e,t,n,r,i,s,a,d){return util_1.Web3Utils.soliditySha3({type:"bytes32",value:util_1.Web3Utils.soliditySha3({type:"address",value:e})},{type:"bytes32",value:util_1.Web3Utils.soliditySha3({type:"address",value:t})},{type:"bytes32",value:util_1.Web3Utils.soliditySha3({type:"address",value:n})},{type:"uint64",value:r},{type:"uint256",value:i},{type:"bytes32",value:s},{type:"uint256",value:a.toFixed(0)},{type:"uint256",value:d.toFixed(0)}).toString()},Object.defineProperty(n.prototype,"hash",{get:function(){return n.checksum(this._contractAddress,this._tokenAddress,this._walletAddress,this._trailIdentifier,this._eonNumber,this._transferTree.hash,this._spent,this._gained)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"json",{get:function(){return{contractAddress:this._contractAddress,tokenAddress:this._tokenAddress,walletAddress:this._walletAddress,trailIdentifier:this._trailIdentifier,eonNumber:this._eonNumber,transfers:this._transfers.map(function(e){return e.json}),pendingTransfer:null==this._pendingTransfer?null:this._pendingTransfer.json,spent:this._spent,gained:this._gained,pendingReceipt:this._pendingReceipt,passivelyGained:this._passivelyGained}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isTransferPending",{get:function(){return null!=this._pendingTransfer&&null!=this._pendingTransfer},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"transfers",{get:function(){return this._transfers},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pendingTransfer",{get:function(){return this._pendingTransfer},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"latestTransfer",{get:function(){return this.isTransferPending?this.pendingTransfer:this.lastConfirmedTransfer},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"lastConfirmedTransfer",{get:function(){var e=this._transfers.length;return 0<e?this._transfers[e-1]:null},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"amount",{get:function(){return this._gained.plus(this._passivelyGained).minus(this._spent)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"spent",{get:function(){return this._spent},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"gained",{get:function(){return this._gained},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"passivelyGained",{get:function(){return this._passivelyGained},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"pendingReceipt",{get:function(){return this._pendingReceipt},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tokenAddress",{get:function(){return this._tokenAddress},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"walletAddress",{get:function(){return this._walletAddress},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"trailIdentifier",{get:function(){return this._trailIdentifier},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"eonNumber",{get:function(){return this._eonNumber},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"transferTree",{get:function(){return this._transferTree},enumerable:!0,configurable:!0}),n.prototype.createIncomingTransfer=function(e,t,n,r,i){if(!this.isTransferPending)return i?this._passivelyGained=this._passivelyGained.plus(t):this._gained=this._gained.plus(t),this._pendingReceipt=this._pendingReceipt.plus(t),this._pendingTransfer=new transfer_model_1.Transfer(this.tokenAddress,e,this._eonNumber,t,null,null,this.tokenAddress,this._walletAddress,this._trailIdentifier,e,n,r,i),this.recalculateTransactionTree(),this._pendingTransfer},n.prototype.createIncomingSwap=function(e,t,n,r,i,s,a){if(logging_1.Logging.debug("createIncomingSwap"),logging_1.Logging.debug([e,t,n.toFixed(0),r.toFixed(0),i.toFixed(0),s.toFixed(0),a]),!this.isTransferPending)return this._pendingTransfer=new transfer_model_1.Transfer(t,e,this._eonNumber,n,r,i,this.tokenAddress,this._walletAddress,this._trailIdentifier,t,s,a,!1),this.recalculateTransactionTree(),this._pendingTransfer},n.prototype.fulfillPendingSwap=function(){if(!this.isTransferPending||!this.pendingTransfer.isSwap)return logging_1.Logging.error("No pending swap."),!1;var e=[this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT),this.pendingTransfer.amountsMatched];if(e.some(function(e){return!e}))return logging_1.Logging.error(e),!1;if(util_1.isSameHexValue(this.pendingTransfer.recipientTokenAddress,this.tokenAddress)){var t=new bignumber_js_1.default(this.pendingTransfer.amountsMatched.in);if(t.lt(this.pendingTransfer.amountSwapped))return logging_1.Logging.error(t.toFixed(0)),logging_1.Logging.error(this.pendingTransfer.amountSwapped.toFixed(0)),!1;this._gained=this._gained.plus(this.pendingTransfer.amountSwapped)}return this.recalculateTransactionTree(),!0},n.prototype.finalizePendingSwap=function(){if(!this.isTransferPending||!this.pendingTransfer.isSwap)return logging_1.Logging.error("No pending swap."),!1;var e=[this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FINALIZATION),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FINALIZATION),this.pendingTransfer.amountsMatched];if(e.some(function(e){return!e}))return logging_1.Logging.error(e),!1;if(util_1.isSameHexValue(this.pendingTransfer.recipientTokenAddress,this.tokenAddress)){var t=new bignumber_js_1.default(this.pendingTransfer.amountsMatched.in);if(t.lt(this.pendingTransfer.amountSwapped))return logging_1.Logging.error(t.toFixed(0)),logging_1.Logging.error(this.pendingTransfer.amountSwapped.toFixed(0)),!1;this._gained=this._gained.plus(t.minus(this.pendingTransfer.amountSwapped))}return this._transfers.push(this._pendingTransfer),this._pendingTransfer=null,this.recalculateTransactionTree(),!0},n.prototype.cancelPendingSwap=function(){if(!this.isTransferPending||!this.pendingTransfer.isSwap)return logging_1.Logging.error("No pending swap."),!1;var e=[this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.RECIPIENT_CANCELLATION),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FREEZING),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.RECIPIENT_CANCELLATION)];return e.some(function(e){return!e})?(logging_1.Logging.error(e),!1):(util_1.isSameHexValue(this.pendingTransfer.recipientTokenAddress,this.tokenAddress)?(this._gained=new bignumber_js_1.default(this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.RECIPIENT_CANCELLATION).updated_gains),this._spent=new bignumber_js_1.default(this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.RECIPIENT_CANCELLATION).updated_spendings)):(this._gained=new bignumber_js_1.default(this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION).updated_gains),this._spent=new bignumber_js_1.default(this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION).updated_spendings)),this._transfers.push(this._pendingTransfer),this._pendingTransfer=null,this.recalculateTransactionTree(),!0)},n.prototype.cancelNonFinalizedPendingSwap=function(){this.isTransferPending&&this.pendingTransfer.isSwap&&!this.pendingTransfer.isSwapFinalized?(this._pendingTransfer=null,this.recalculateTransactionTree()):logging_1.Logging.log("No pending swap.")},n.prototype.confirmPendingIncomingTransfer=function(){if(this.isTransferPending&&util_1.isSameHexValue(this.pendingTransfer.recipient,this.walletAddress))return this.confirmPendingTransfer()},n.prototype.confirmPendingOutgoingTransfer=function(){return!(!this.isTransferPending||!util_1.isSameHexValue(this.pendingTransfer.sender,this.walletAddress))&&this.confirmPendingTransfer()},n.prototype.confirmPendingTransfer=function(){return!(!this.isTransferPending||!this.pendingTransfer)&&(!(this.pendingTransfer.isPassive?[this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT)]:[this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),this.pendingTransfer.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT)]).some(function(e){return!e})&&(this._pendingReceipt=new bignumber_js_1.default("0"),this._transfers.push(this._pendingTransfer),this._pendingTransfer=null,this.recalculateTransactionTree(),!0))},n.prototype.cancelPendingTransfer=function(){this.isTransferPending&&(this.pendingTransfer.sender==this.walletAddress?this._spent=this._spent.minus(this._pendingTransfer.amount):(this._pendingReceipt=this._pendingReceipt.minus(this._pendingTransfer.amount),this._gained=this._gained.minus(this._pendingTransfer.amount)),this._pendingTransfer=null,this.recalculateTransactionTree())},n.prototype.createOutgoingTransfer=function(e,t,n,r,i,s,a){if(void 0===a&&(a=null),!this.isTransferPending)return this._spent=this._spent.plus(n),this._pendingTransfer=new transfer_model_1.Transfer(this.tokenAddress,this._walletAddress,this._eonNumber,n,null,null,this.tokenAddress,e,t,e,i,s,r,a),this.recalculateTransactionTree(),this._pendingTransfer},n.prototype.createOutgoingSwap=function(e,t,n,r,i,s,a,d){if(logging_1.Logging.debug("createOutgoingSwap"),logging_1.Logging.debug([e,t,n,r.toFixed(0),i.toFixed(0),s.toFixed(0),a?a.toFixed(0):a,d]),!this.isTransferPending)return this._spent=this._spent.plus(r),this._pendingTransfer=new transfer_model_1.Transfer(this.tokenAddress,this._walletAddress,this._eonNumber,r,i,s,t,e,n,t,a,d,!1),this.recalculateTransactionTree(),this._pendingTransfer},n.prototype.recalculateTransactionTree=function(){var t=this;this._transferLeaves=new Map;var e=this._transfers;this.isTransferPending&&(e=e.concat(this._pendingTransfer));var n=0<(e=e.filter(function(e){return!(e.isPassive&&util_1.isSameHexValue(e.recipient,t.walletAddress))})).length&&e.filter(function(e){return e.isPassive&&util_1.isSameHexValue(e.sender,t.walletAddress)});n&&n.slice(0,-1).map(function(e){return e.finalizePassive()});var r=0<n.length&&n[n.length-1];if(r&&r.txId!==e[e.length-1].txId&&r.finalizePassive(),0<e.length){for(var i=1;i<e.length;)i*=2;for(;e.length<i;)e=e.concat(transfer_model_1.Transfer.PADDING_TRANSFER)}this._transferTree=new merkle_tree_model_1.MerkleTree(e,this._transferLeaves,0)},n}(hashable_model_1.Hashable);exports.ActiveState=ActiveState;