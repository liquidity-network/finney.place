"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var eon_model_1=require("./eon.model"),async_mutex_1=require("async-mutex"),signature_model_1=require("../primitives/signature.model"),active_state_model_1=require("../transactions/active-state.model"),bignumber_js_1=__importDefault(require("bignumber.js")),minimum_balance_marker_model_1=require("../transactions/minimum-balance-marker.model"),Wallet=function(){function i(e,t,r,n,i,o){this._address=e,this._networkId=t,this._contractOwnerAddress=r,this._contractAddress=n,this._tokenAddress=i,this._webAddress=o,this._registered=!1,this._pendingRegistrationApproval=!1,this._eons=new Map,this._latestEonNumber=0,this._onChainBalance=new bignumber_js_1.default(0),this._lock=new async_mutex_1.Mutex,this._eons.set(0,new eon_model_1.Eon(n,i,e,0,0))}return i.fromJSON=function(e){var t=new i(e.address,e.networkId,e.contractOwnerAddress,e.contractAddress,e.tokenAddress,e.webAddress);for(var r in t._trailIdentifier=e.trailIdentifier,t._registered=e.registered,t._registrationEon=e.registrationEon,t._pendingRegistrationApproval=e.pendingRegistrationApproval,t._registrationApproval=e.registrationApproval?signature_model_1.Signature.fromJSON(e.registrationApproval):void 0,e.eons)if(e.eons.hasOwnProperty(r)){var n=e.eons[r];t._eons.set(parseInt(r,10),eon_model_1.Eon.fromJSON(n))}return t._onChainBalance=new bignumber_js_1.default(e.onChainBalance),t._latestEonNumber=parseInt(e.latestEonNumber,10),t},Object.defineProperty(i.prototype,"json",{get:function(){var n={};return this._eons.forEach(function(e,t,r){n[t]=e.json}),{address:this._address,networkId:this._networkId,contractOwnerAddress:this._contractOwnerAddress,contractAddress:this._contractAddress,tokenAddress:this._tokenAddress,webAddress:this._webAddress,trailIdentifier:this._trailIdentifier,registered:this._registered,registrationEon:this._registrationEon,pendingRegistrationApproval:this._pendingRegistrationApproval,registrationApproval:this.registrationApproval?this.registrationApproval.json:void 0,eons:n,latestEonNumber:this._latestEonNumber,onChainBalance:this._onChainBalance}},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isRegistered",{get:function(){return this._registered},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"isPendingRegistrationApproval",{get:function(){return this._pendingRegistrationApproval},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"address",{get:function(){return this._address},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"contractAddress",{get:function(){return this._contractAddress},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"contractOwnerAddress",{get:function(){return this._contractOwnerAddress},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"tokenAddress",{get:function(){return this._tokenAddress},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"networkId",{get:function(){return this._networkId},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"trailIdentifier",{get:function(){return this._trailIdentifier},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"webAddress",{get:function(){return this._webAddress},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"latestEon",{get:function(){return this.getEon(this._latestEonNumber)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"previousEon",{get:function(){return this.getEon(this._latestEonNumber-1)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"secondPreviousEon",{get:function(){return this.getEon(this._latestEonNumber-2)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"lock",{get:function(){return this._lock},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"registrationEon",{get:function(){return this._registrationEon},enumerable:!0,configurable:!0}),i.prototype.getAdmissionActiveState=function(e,t){return void 0===t&&(t=0),new active_state_model_1.ActiveState(this.contractAddress,this.tokenAddress,this.address,t,e)},i.prototype.markRegistered=function(e,t){if(!this.isRegistered){this._registrationApproval=e,this._registered=!0,this.unmarkPendingRegistrationApproval(),this._latestEonNumber=this.registrationEon,this._trailIdentifier=t;var r=new eon_model_1.Eon(this.contractAddress,this.tokenAddress,this.address,this.trailIdentifier,this.registrationEon);this._eons.set(r.eonNumber,r)}},Object.defineProperty(i.prototype,"registrationApproval",{get:function(){return this._registrationApproval},enumerable:!0,configurable:!0}),i.prototype.markPendingRegistrationApproval=function(e){this._registrationEon=e,this._pendingRegistrationApproval=!0},i.prototype.unmarkPendingRegistrationApproval=function(){this._pendingRegistrationApproval=!1},i.prototype.getEon=function(e){return this._eons.get(e)},i.prototype.addEon=function(e){if(e.eonNumber!=this._latestEonNumber+1)return!1;this._eons.set(e.eonNumber,e),this._latestEonNumber=e.eonNumber},i.prototype.addEonForce=function(e){this._eons.set(e.eonNumber,e),this._latestEonNumber=e.eonNumber},Object.defineProperty(i.prototype,"withdrawableAmount",{get:function(){if(!this.previousEon||!this.previousEon.proofOfExclusiveAllotment)return new bignumber_js_1.default(0);var e=this.previousEon.minimumAuthorizedBalance?this.previousEon.minimumAuthorizedBalance.amount:this.previousEon.availableBalance,t=bignumber_js_1.default.min(this.previousEon.chainBalance,e),r=this.latestEon.minimumAuthorizedBalance?this.latestEon.minimumAuthorizedBalance.amount:this.offChainBalance;return bignumber_js_1.default.min(t,r)},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"onChainBalance",{get:function(){return this._onChainBalance},set:function(e){this._onChainBalance=e},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"offChainBalance",{get:function(){var e=new bignumber_js_1.default(0);if(!this.latestEon)return e;var t=this.latestEon.availableBalance;return!this.latestEon.proofOfExclusiveAllotment&&this.previousEon&&(t=t.plus(this.previousEon.availableBalance)),t},enumerable:!0,configurable:!0}),Object.defineProperty(i.prototype,"minimumAvailableBalanceMarker",{get:function(){return new minimum_balance_marker_model_1.MinimumAvailableBalanceMarker(this._contractAddress,this._tokenAddress,this._address,this.latestEon.eonNumber,this.offChainBalance)},enumerable:!0,configurable:!0}),i.prototype.getEonSwapStartingBalance=function(e){var t=new bignumber_js_1.default(0);if(e<=this.registrationEon)return t;var r=this.getEon(e);if(r&&r.proofOfExclusiveAllotment)return r.chainBalance;var n=this.getEon(e-1);return n?n.availableBalance:t},i}();exports.Wallet=Wallet;