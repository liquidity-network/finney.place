"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var withdrawal_model_1=require("./../transactions/withdrawal.model"),active_state_model_1=require("../transactions/active-state.model"),proof_of_exclusive_allotment_model_1=require("../primitives/proof-of-exclusive-allotment.model"),deposit_model_1=require("../transactions/deposit.model"),minimum_balance_marker_model_1=require("../transactions/minimum-balance-marker.model"),bignumber_js_1=__importDefault(require("bignumber.js")),Eon=function(){function n(e,t,n,r,i){this._contractAddress=e,this._tokenAddress=t,this._walletAddress=n,this._trailIdentifier=r,this._eonNumber=i,this._withdrawals=[],this._deposits=[],this._deposited=new bignumber_js_1.default("0"),this._depositedOnChain=new bignumber_js_1.default("0"),this._pendingIncomingTransfers=[],this._cancelledTransfers=[],this._activeState=new active_state_model_1.ActiveState(e,t,n,r,i)}return n.fromJSON=function(e){var t=new n(e.contractAddress,e.tokenAddress,e.walletAddress,e.trailIdentifier,e.eonNumber);return null!=e.activeState&&(t._activeState=active_state_model_1.ActiveState.fromJSON(e.activeState)),null!=e.proofOfExclusiveAllotment&&(t._proofOfExclusiveAllotment=proof_of_exclusive_allotment_model_1.ProofOfExclusiveAllotment.fromJSON(e.proofOfExclusiveAllotment)),null!=e.proposedProofOfExclusiveAllotment&&(t.proposedProofOfExclusiveAllotment=proof_of_exclusive_allotment_model_1.ProofOfExclusiveAllotment.fromJSON(e.proposedProofOfExclusiveAllotment)),t._withdrawals=e.withdrawals.map(function(e){return withdrawal_model_1.Withdrawal.fromJSON(e)}),t._deposits=e.deposits.map(function(e){return deposit_model_1.Deposit.fromJSON(e)}),t._deposited=new bignumber_js_1.default(e.deposited),t._depositedOnChain=new bignumber_js_1.default(e.depositedOnChain),null!=e.minimumAuthorizedBalance&&(t._minimumAuthorizedBalance=minimum_balance_marker_model_1.MinimumAvailableBalanceMarker.fromJSON(e.minimumAuthorizedBalance)),t._pendingIncomingTransfers=e.pendingIncomingTransfers,t._cancelledTransfers=e.cancelledTransfers,t},Object.defineProperty(n.prototype,"json",{get:function(){return{contractAddress:this._contractAddress,tokenAddress:this._tokenAddress,walletAddress:this._walletAddress,trailIdentifier:this._trailIdentifier,eonNumber:this._eonNumber,activeState:null==this._activeState?null:this._activeState.json,proofOfExclusiveAllotment:null==this._proofOfExclusiveAllotment?null:this._proofOfExclusiveAllotment.json,proposedProofOfExclusiveAllotment:null==this.proposedProofOfExclusiveAllotment?null:this.proposedProofOfExclusiveAllotment.json,withdrawals:this._withdrawals.map(function(e){return e.json}),deposits:this._deposits.map(function(e){return e.json}),deposited:this._deposited,depositedOnChain:this._depositedOnChain,minimumAuthorizedBalance:this._minimumAuthorizedBalance,pendingIncomingTransfers:this._pendingIncomingTransfers,cancelledTransfers:this._cancelledTransfers}},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"eonNumber",{get:function(){return this._eonNumber},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"proofOfExclusiveAllotment",{get:function(){return this._proofOfExclusiveAllotment},enumerable:!0,configurable:!0}),n.prototype.setProofOfExclusiveAllotment=function(e){return this._proofOfExclusiveAllotment=e,!0},Object.defineProperty(n.prototype,"chainBalance",{get:function(){return this._proofOfExclusiveAllotment?this._proofOfExclusiveAllotment.amount:new bignumber_js_1.default("0")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"proposedChainBalance",{get:function(){return this.proposedProofOfExclusiveAllotment?this.proposedProofOfExclusiveAllotment.amount:new bignumber_js_1.default("0")},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"activeState",{get:function(){return this._activeState},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"currentEonWithdrawalAmount",{get:function(){for(var e=new bignumber_js_1.default(0),t=0;t<this._withdrawals.length;t++)this._withdrawals[t].eonNumber==this._eonNumber&&(e=e.plus(this._withdrawals[t].amount));return e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"isWithdrawalPending",{get:function(){return 0<this._withdrawals.length},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"walletAddress",{get:function(){return this._walletAddress},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"trailIdentifier",{get:function(){return this._trailIdentifier},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"contractAddress",{get:function(){return this._contractAddress},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"tokenAddress",{get:function(){return this._tokenAddress},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"withdrawalAmount",{get:function(){return this._withdrawals.map(function(e){return e.amount}).reduce(function(e,t){return e.plus(t)})},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"availableBalance",{get:function(){var e=this.chainBalance.plus(this.offChainDeposited),t=this.currentEonWithdrawalAmount;return e.plus(this.activeState.amount).minus(t).minus(this.activeState.pendingReceipt)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"expectedBalance",{get:function(){var e=this.chainBalance.plus(this.onChainDeposit),t=this.currentEonWithdrawalAmount;return e.plus(this.activeState.amount).minus(t).minus(this.activeState.pendingReceipt)},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"minimumAuthorizedBalance",{get:function(){return this._minimumAuthorizedBalance},set:function(e){this._minimumAuthorizedBalance=e},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"availableBalanceMarker",{get:function(){return new minimum_balance_marker_model_1.MinimumAvailableBalanceMarker(this._contractAddress,this._tokenAddress,this._walletAddress,this._eonNumber,this.availableBalance)},enumerable:!0,configurable:!0}),n.prototype.setOnChainWithdrawals=function(e){this._withdrawals=e},Object.defineProperty(n.prototype,"withdrawals",{get:function(){return this._withdrawals},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"deposits",{get:function(){return this._deposits},enumerable:!0,configurable:!0}),Object.defineProperty(n.prototype,"offChainDeposited",{get:function(){return this._deposited},enumerable:!0,configurable:!0}),n.prototype.addDeposit=function(t){return!this._deposits.find(function(e){return e.txId==t.txId})&&(this._deposits.push(t),this._deposited=this._deposited.plus(t.amount),!0)},Object.defineProperty(n.prototype,"onChainDeposit",{get:function(){return this._depositedOnChain},set:function(e){this._depositedOnChain=e},enumerable:!0,configurable:!0}),n.prototype.isCancelledTransfer=function(t){return null!=this.cancelledTransfers.find(function(e){return e.id==t.id})},n.prototype.addCancelledTransfer=function(e){this.isCancelledTransfer(e)||this._cancelledTransfers.push(e)},Object.defineProperty(n.prototype,"cancelledTransfers",{get:function(){return this._cancelledTransfers},enumerable:!0,configurable:!0}),n.prototype.isPendingIncomingTransfer=function(t){return null!=this.pendingIncomingTransfers.find(function(e){return e.id==t.id})},n.prototype.addPendingIncomingTransfer=function(e){this.isPendingIncomingTransfer(e)||this._pendingIncomingTransfers.push(e)},n.prototype.removePendingIncomingTransfer=function(t){var e=this.pendingIncomingTransfers.findIndex(function(e){return e.id==t.id});-1!=e&&this.pendingIncomingTransfers.splice(e,1)},Object.defineProperty(n.prototype,"pendingIncomingTransfers",{get:function(){return this._pendingIncomingTransfers},enumerable:!0,configurable:!0}),n}();exports.Eon=Eon;