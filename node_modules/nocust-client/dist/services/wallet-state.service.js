"use strict";var __decorate=this&&this.__decorate||function(e,t,r,a){var n,_=arguments.length,i=_<3?t:null===a?a=Object.getOwnPropertyDescriptor(t,r):a;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)i=Reflect.decorate(e,t,r,a);else for(var o=e.length-1;0<=o;o--)(n=e[o])&&(i=(_<3?n(i):3<_?n(t,r,i):n(t,r))||i);return 3<_&&i&&Object.defineProperty(t,r,i),i},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(r,a){return function(e,t){a(e,t,r)}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var withdrawal_model_1=require("./../models/transactions/withdrawal.model"),inversify_1=require("inversify"),inversify_types_1=require("../inversify.types"),rxjs_1=require("rxjs"),contract_api_service_1=require("./contract-api.service"),operator_api_service_1=require("./operator-api.service"),wallet_state_model_1=require("../models/state/wallet-state.model"),eon_model_1=require("../models/wallet/eon.model"),bignumber_js_1=__importDefault(require("bignumber.js")),wallet_sync_state_model_1=require("../models/state/wallet-sync-state.model"),signature_model_1=require("../models/primitives/signature.model"),active_state_model_1=require("../models/transactions/active-state.model"),proof_of_exclusive_allotment_model_1=require("../models/primitives/proof-of-exclusive-allotment.model"),util_1=require("../util"),wallet_update_error_model_1=require("../models/state/wallet-update-error.model"),operators_1=require("rxjs/internal/operators"),deposit_model_1=require("../models/transactions/deposit.model"),transfer_model_1=require("../models/transactions/transfer.model"),logging_1=require("./logging"),transfer_active_state_update_type_model_1=require("../models/transactions/transfer-active-state-update-type.model"),WalletStateService=function(){function e(e,t,r,a,n,_){var i=this;this.walletStatePollObservable=e,this.operatorStateFetchObservable=t,this.contractStateFetchObservable=r,this.walletStateSyncObserver=a,this.contractApi=n,this.operatorApi=_,e.subscribe(function(a){rxjs_1.combineLatest(r,t).pipe(operators_1.take(1)).subscribe(function(e){var t=e[0],r=e[1];i.syncWalletState(a.wallet,t,r).then(function(e){i.walletStateSyncObserver.next(e)})})})}return e.prototype.syncWalletState=function(r,a,n,_){var i=this;return void 0===_&&(_=!0),r.lock.runExclusive(function(){return i.updateOnChainData(r,a,n).then(function(){return i.updatePendingRegistrationState(r,a,n)}).then(function(){return i.updateRegistrationState(r,a,n)}).then(function(){return i.updateLightSyncEon(r,a,n,_)}).then(function(){return i.updateOlderEonStates(r,a,n,_)}).then(function(){return i.updatePreviousEonState(r,a,n,_)}).then(function(){return new Promise(function(e,t){return i.updateCurrentEonState(r,a,n,_).then(function(){return a.isPunished?t(wallet_update_error_model_1.WalletUpdateError.PROVIDER_PUNISHED):e(new wallet_state_model_1.WalletState(r,wallet_sync_state_model_1.WalletSyncState.SYNCHRONIZED,null,a,n))}).catch(t)})}).catch(function(e){return logging_1.Logging.debug(e),new wallet_state_model_1.WalletState(r,wallet_sync_state_model_1.WalletSyncState.UNSAFE,e,a,n)})})},e.prototype.updateOnChainData=function(r,a,e){return logging_1.Logging.debug("updateOnChainData"),new Promise(function(e,t){return r?a?a.networkId!=r.networkId?t(wallet_update_error_model_1.WalletUpdateError.INCORRECT_NETWORK_ID):(r.onChainBalance=a.onChainBalance,e()):t(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED):t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED)})},e.prototype.updatePendingRegistrationState=function(a,n,e){var _=this;logging_1.Logging.debug("updatePendingRegistrationState");var i,o=e?e.walletData:null;return new Promise(function(t,r){if(!a)return r(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(a.isRegistered)return t();if(!n)return r(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED);if(!(o&&o.registration&&o.registration.wallet_signature&&o.registration.eon_number))return a.unmarkPendingRegistrationApproval(),r(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED_NO_REQUEST);if(o.registration.eon_number>n.currentEonNumber)return a.unmarkPendingRegistrationApproval(),r(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED_BAD_REQUEST);i=a.getAdmissionActiveState(o.registration.eon_number);var e=signature_model_1.Signature.fromRSV(a.address,i.hash,o.registration.wallet_signature);_.contractApi.validateActiveStateSignature(i,e,a.contractAddress).then(function(e){return e?(a.markPendingRegistrationApproval(o.registration.eon_number),t()):r(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED_BAD_REQUEST)}).catch(r)})},e.prototype.updateRegistrationState=function(n,e,t){var _=this;logging_1.Logging.debug("updateRegistrationState");var i,o=t?t.walletData:null;return new Promise(function(t,r){if(!n)return r(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(n.isRegistered)return t();if(!n.isPendingRegistrationApproval)return r(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED_APPROVAL_NOT_PENDING);if(!e)return r(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED);if(!o||!o.registration||!o.registration.operator_signature)return r(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED_APPROVAL_NOT_PROVIDED);i=n.getAdmissionActiveState(n.registrationEon,o.registration.trail_identifier);var a=signature_model_1.Signature.fromRSV(n.contractOwnerAddress,i.hash,o.registration.operator_signature);_.contractApi.validateActiveStateSignature(i,a,n.contractAddress).then(function(e){return e?(n.markRegistered(a,o.registration.trail_identifier),t()):r(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED_APPROVAL_INVALID)}).catch(r)})},e.prototype.updateOlderEonStates=function(r,a,n,_){var i=this;return logging_1.Logging.debug("updateOlderEonStates"),new Promise(function(e,t){return r?r.isRegistered?a?r.latestEon.eonNumber>=a.currentEonNumber-1?e():i.updateLatestLocalEonProofOfExclusiveAllotment(r,a,n,_).then(function(){return i.updateLatestEonActiveState(r,a,n,_)}).then(function(){return i.updateLatestEonDeposits(r,a,n)}).then(function(){return i.updateLatestEonOnChainWithdrawal(r,a,n)}).then(function(){return i.updateLatestEonDeliveryReceipts(r,a,n,_)}).then(function(){return i.progressEon(r,a,n)}).then(function(){return i.updateOlderEonStates(r,a,n,!1)}).then(e).catch(t):t(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED):t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED):t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED)})},e.prototype.updatePreviousEonState=function(r,a,n,_){var i=this;return logging_1.Logging.debug("updatePreviousEonState"),new Promise(function(e,t){return r?r.isRegistered?a?r.latestEon.eonNumber<a.currentEonNumber-1?t(wallet_update_error_model_1.WalletUpdateError.LOGIC_OLD_EONS_NOT_UPDATED):r.latestEon.eonNumber==a.currentEonNumber?e():i.updateLatestLocalEonProofOfExclusiveAllotment(r,a,n,!1).then(function(){return i.updateLatestEonActiveState(r,a,n,_)}).then(function(){return i.updateLatestEonDeposits(r,a,n)}).then(function(){return i.updateLatestEonOnChainWithdrawal(r,a,n)}).then(function(){return i.updateLatestEonDeliveryReceipts(r,a,n,!1)}).then(function(){return i.progressEon(r,a,n)}).then(e).catch(t):t(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED):t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED):t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED)})},e.prototype.updateCurrentEonState=function(r,a,n,_){var i=this;return logging_1.Logging.debug("updateCurrentEonState"),new Promise(function(e,t){return r?r.isRegistered?a?r.latestEon.eonNumber<a.currentEonNumber?t(wallet_update_error_model_1.WalletUpdateError.LOGIC_PREVIOUS_EON_NOT_UPDATED):i.updateCurrentEonOnChainDeposits(r,a,n).then(function(){return i.updateLatestLocalEonProofOfExclusiveAllotment(r,a,n,!1)}).then(function(){return i.updateLatestEonActiveState(r,a,n,_)}).then(function(){return i.updateLatestEonDeposits(r,a,n)}).then(function(){return i.updateLatestEonOnChainWithdrawal(r,a,n)}).then(function(){return i.updateLatestEonDeliveryReceipts(r,a,n,!1)}).then(e).catch(t):t(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED):t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED):t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED)})},e.prototype.updateLatestLocalEonProofOfExclusiveAllotment=function(o,s,e,l){var d=this;logging_1.Logging.debug("updateLatestLocalEonProofOfExclusiveAllotment");var u=e?e.walletData:null;return new Promise(function(t,r){if(!o)return r(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!o.isRegistered)return r(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);if(!s)return r(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED);var a=o.latestEon;if(!a)return r(wallet_update_error_model_1.WalletUpdateError.LOCAL_DATA_MISSING_LATEST_EON);if(a.proofOfExclusiveAllotment||a.eonNumber==o.registrationEon)return t();if(a.eonNumber==s.currentEonNumber&&!s.isCheckpointSubmitted)return s.currentSubBlock>s.extendedSlackPeriod?r(wallet_update_error_model_1.WalletUpdateError.REMOTE_DATA_MISSING_MERKLE_PROOF):t();var n,_=l&&o.latestEon.eonNumber===s.currentEonNumber-2;if(!_){if(!(n=o.getEon(a.eonNumber-1)))return r(wallet_update_error_model_1.WalletUpdateError.LOCAL_DATA_MISSING_PREVIOUS_EON);if(!u||!u.merkle_proofs||!u.merkle_proofs.length)return r(wallet_update_error_model_1.WalletUpdateError.REMOTE_DATA_NO_MERKLE_PROOFS)}var e=u.merkle_proofs.find(function(e){return e.eon_number==a.eonNumber});if(!e)return r(wallet_update_error_model_1.WalletUpdateError.REMOTE_DATA_MISSING_MERKLE_PROOF);if(e.trail!=o.trailIdentifier)return r(wallet_update_error_model_1.WalletUpdateError.PROOF_OF_EXCLUSIVE_ALLOTMENT_INVALID_TRAIL);var i=new proof_of_exclusive_allotment_model_1.ProofOfExclusiveAllotment(o.contractAddress,o.tokenAddress,o.address,e.active_state_checksum,e.trail,e.eon_number,e.allotment_chain,e.membership_chain,e.values.map(function(e){return new bignumber_js_1.default(e)}),new bignumber_js_1.default(e.left),new bignumber_js_1.default(e.right),e.passive_checksum,new bignumber_js_1.default(e.passive_amount),new bignumber_js_1.default(e.passive_marker));return a.proposedProofOfExclusiveAllotment=i,!_&&i.amount.isLessThan(n.expectedBalance)?r(wallet_update_error_model_1.WalletUpdateError.PROOF_OF_EXCLUSIVE_ALLOTMENT_INSUFFICIENT_BALANCE):a.eonNumber<=s.currentEonNumber-s.eonsKept+1?(a.setProofOfExclusiveAllotment(i),t()):void d.contractApi.verifyProof(a,i).then(function(e){if(!e)return r(wallet_update_error_model_1.WalletUpdateError.PROOF_OF_EXCLUSIVE_ALLOTMENT_INVALID);if(!_&&n.activeState.transferTree.isEmpty){if(!util_1.isSameHexValue(i.activeStateChecksum,util_1.EMPTY_HASH)&&!util_1.isSameHexValue(i.activeStateChecksum,n.activeState.hash))return logging_1.Logging.error(i.activeStateChecksum),logging_1.Logging.error("not empty"),r(wallet_update_error_model_1.WalletUpdateError.PROOF_OF_EXCLUSIVE_ALLOTMENT_UNEXPECTED_ACTIVE_STATE_CHECKSUM)}else if(!_&&!util_1.isSameHexValue(i.activeStateChecksum,n.activeState.hash))return logging_1.Logging.error(i.activeStateChecksum),logging_1.Logging.error(n.activeState.hash),logging_1.Logging.log(n.activeState),r(wallet_update_error_model_1.WalletUpdateError.PROOF_OF_EXCLUSIVE_ALLOTMENT_UNEXPECTED_ACTIVE_STATE_CHECKSUM);return a.setProofOfExclusiveAllotment(i),t()}).catch(r)})},e.prototype.updateLatestEonActiveState=function(n,_,i,o){var s=this;logging_1.Logging.debug("updateLatestEonActiveState");var l=i?i.walletData:null;return new Promise(function(e,t){if(!n)return t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!n.isRegistered)return t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);if(!l||!l.transfers)return e();var r=n.latestEon;if(!r)return t(wallet_update_error_model_1.WalletUpdateError.LOCAL_DATA_MISSING_LATEST_EON);var a=l.transfers.filter(function(e){return e.eon_number==r.eonNumber}).sort(function(e,t){return e.id-t.id});return s.updateLatestEonActiveStateTransactions(n,a,0,_,i,o).then(e).catch(t)})},e.prototype.updateLatestEonActiveStateTransactions=function(n,_,i,o,s,l){var d=this;return logging_1.Logging.debug("updateLatestEonActiveStateTransactions"),new Promise(function(e,t){if(!n)return t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!n.isRegistered)return t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);if(!_||i>=_.length)return e();var r=function(e,t){return d.updateLatestEonActiveStateTransactions(n,_,i+1,o,s,l).then(e).catch(t)},a=_[i];return(util_1.isSameHexValue(a.wallet.address,a.recipient.address)&&!util_1.isSameHexValue(a.wallet.token,a.recipient.token)?d.updateLatestEonActiveStateSwaps(n,a,o,s,r,l):d.updateLatestEonActiveStateTransfers(n,a,o,s,r,l)).then(e).catch(t)})},e.prototype.updateLatestEonActiveStateTransfers=function(o,s,e,t,l,d){var u=this;return logging_1.Logging.debug("updateLatestEonActiveStateTransfers"),new Promise(function(t,r){var _=util_1.isSameHexValue(s.wallet.address,o.address)&&util_1.isSameHexValue(s.wallet.token,o.tokenAddress),i=o.latestEon,a=i.activeState.latestTransfer,n=function(a,n){return u.contractApi.validateTransferDebit(s,o.contractOwnerAddress,o.contractAddress,o.tokenAddress,d).then(function(e){if(!e)return n(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TRANSFER_DEBIT_HUB_SIGNATURE_INVALID);var t=active_state_model_1.ActiveState.checksum(o.contractAddress,o.tokenAddress,s.wallet.address,s.wallet_trail_identifier,s.eon_number,s.sender_active_state.tx_set_hash,new bignumber_js_1.default(s.sender_active_state.updated_spendings),new bignumber_js_1.default(s.sender_active_state.updated_gains)),r=signature_model_1.Signature.fromRSV(o.contractOwnerAddress,t,s.sender_active_state.operator_signature);if(i.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,r),s.passive){if(_){if(!i.activeState.confirmPendingOutgoingTransfer())return n(wallet_update_error_model_1.WalletUpdateError.LOGIC_TRANSFER_CONFIRM_ERROR_OUTGOING)}else if(!i.activeState.confirmPendingIncomingTransfer())return n(wallet_update_error_model_1.WalletUpdateError.LOGIC_TRANSFER_CONFIRM_ERROR_INCOMING);return l(a,n)}return u.contractApi.validateTransferCredit(s,o.contractOwnerAddress,o.contractAddress,o.tokenAddress,d).then(function(e){if(!e)return n(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TRANSFER_CREDIT_HUB_SIGNATURE_INVALID);var t=active_state_model_1.ActiveState.checksum(o.contractAddress,o.tokenAddress,s.recipient.address,s.recipient_trail_identifier,s.eon_number,s.recipient_active_state.tx_set_hash,new bignumber_js_1.default(s.recipient_active_state.updated_spendings),new bignumber_js_1.default(s.recipient_active_state.updated_gains)),r=signature_model_1.Signature.fromRSV(o.contractOwnerAddress,t,s.recipient_active_state.operator_signature);if(i.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT,r),_){if(!i.activeState.confirmPendingOutgoingTransfer())return n(wallet_update_error_model_1.WalletUpdateError.LOGIC_TRANSFER_CONFIRM_ERROR_OUTGOING)}else if(!i.activeState.confirmPendingIncomingTransfer())return n(wallet_update_error_model_1.WalletUpdateError.LOGIC_TRANSFER_CONFIRM_ERROR_INCOMING);return l(a,n)})})};if(a&&s.id<a.txId)return l(t,r);if(a&&s.id==a.txId){if(i.removePendingIncomingTransfer(s),!i.activeState.isTransferPending)return l(t,r);if(s.processed&&s.voided)return i.addCancelledTransfer(s),i.activeState.cancelPendingTransfer(),l(t,r);if(_){if(!util_1.isSameHexValue(i.activeState.transferTree.hash,s.sender_active_state.tx_set_hash))return r(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TX_SET_ROOT_INVALID_OUTGOING)}else if(s.recipient_active_state&&!util_1.isSameHexValue(i.activeState.transferTree.hash,s.recipient_active_state.tx_set_hash))return r(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TX_SET_ROOT_INVALID_INCOMING);return u.contractApi.validateTransferDebit(s,s.wallet.address,o.contractAddress,o.tokenAddress,d).then(function(e){return e?s.passive?s.processed?n(t,r):l(t,r):s.recipient_active_state?(a.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT)||a.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,s.sender_active_state),u.contractApi.validateTransferCredit(s,s.recipient.address,o.contractAddress,o.tokenAddress,d).then(function(e){return e?(a.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT)||a.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT,s.recipient_active_state),s.processed?n(t,r):l(t,r)):r(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TRANSFER_CREDIT_WALLET_SIGNATURE_INVALID)})):l(t,r):r(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TRANSFER_DEBIT_WALLET_SIGNATURE_INVALID)})}if(s.processed&&s.voided)return i.removePendingIncomingTransfer(s),i.addCancelledTransfer(s),l(t,r);var e=active_state_model_1.ActiveState.fromJSON(i.activeState.json);e.isTransferPending&&e.cancelPendingTransfer();_?e.createOutgoingTransfer(s.recipient.address,s.recipient_trail_identifier,new bignumber_js_1.default(s.amount),s.passive,new bignumber_js_1.default(s.nonce)):e.createIncomingTransfer(s.wallet.address,new bignumber_js_1.default(s.amount),new bignumber_js_1.default(s.nonce),s.id,s.passive);if(_){if(i.activeState.isTransferPending)return r(wallet_update_error_model_1.WalletUpdateError.LOGIC_AGGREGATION_FORK);if(!util_1.isSameHexValue(e.transferTree.hash,s.sender_active_state.tx_set_hash))return r(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TX_SET_ROOT_INVALID_OUTGOING)}else if(s.recipient_active_state){if(i.activeState.isTransferPending)return r(wallet_update_error_model_1.WalletUpdateError.LOGIC_AGGREGATION_FORK);if(!util_1.isSameHexValue(e.transferTree.hash,s.recipient_active_state.tx_set_hash))return r(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TX_SET_ROOT_INVALID_INCOMING)}return u.contractApi.validateTransferDebit(s,s.wallet.address,o.contractAddress,o.tokenAddress,d).then(function(e){return e?(_?i.activeState.createOutgoingTransfer(s.recipient.address,s.recipient_trail_identifier,new bignumber_js_1.default(s.amount),s.passive,new bignumber_js_1.default(s.nonce),s.id,new bignumber_js_1.default(s.position)).authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,s.sender_active_state):i.addPendingIncomingTransfer(s),s.recipient_active_state||s.passive?s.passive?(_||(i.activeState.createIncomingTransfer(s.wallet.address,new bignumber_js_1.default(s.amount),new bignumber_js_1.default(s.nonce),s.id,s.passive).authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,s.sender_active_state),i.removePendingIncomingTransfer(s)),s.processed?n(t,r):l(t,r)):u.contractApi.validateTransferCredit(s,s.recipient.address,o.contractAddress,o.tokenAddress,d).then(function(e){return e?(_||(i.activeState.createIncomingTransfer(s.wallet.address,new bignumber_js_1.default(s.amount),new bignumber_js_1.default(s.nonce),s.id,s.passive).authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,s.sender_active_state),i.removePendingIncomingTransfer(s)),i.activeState.latestTransfer.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT,s.recipient_active_state),s.processed?n(t,r):l(t,r)):r(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TRANSFER_CREDIT_WALLET_SIGNATURE_INVALID)}):l(t,r)):r(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TRANSFER_DEBIT_WALLET_SIGNATURE_INVALID)})})},e.prototype.updateLatestEonActiveStateSwaps=function(u,c,e,p,E,f){var m=this;return logging_1.Logging.debug("updateLatestEonActiveStateSwaps"),new Promise(function(i,o){var n=util_1.isSameHexValue(c.wallet.address,u.address)&&util_1.isSameHexValue(c.wallet.token,u.tokenAddress),s=u.latestEon,e=s.activeState.latestTransfer;if(!(util_1.isSameHexValue(c.wallet.address,c.recipient.address)&&!util_1.isSameHexValue(c.wallet.token,c.recipient.token)))return o(wallet_update_error_model_1.WalletUpdateError.LOGIC_AGGREGATION_FORK);var a=function(){logging_1.Logging.debug("processSwapFinalization");c.matched_amounts;if(!c.recipient_finalization_active_state)return!c.processed&&p.statusData.confirmed.eon_number>c.eon_number&&s.activeState.cancelNonFinalizedPendingSwap(),E(i,o);if(n){if(s.activeState.latestTransfer.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FINALIZATION,c.recipient_finalization_active_state),!c.recipient_finalization_active_state.operator_signature)return E(i,o);var e=active_state_model_1.ActiveState.checksum(u.contractAddress,c.recipient.token,c.recipient.address,c.recipient_trail_identifier,c.eon_number,c.recipient_finalization_active_state.tx_set_hash,new bignumber_js_1.default(c.recipient_finalization_active_state.updated_spendings),new bignumber_js_1.default(c.recipient_finalization_active_state.updated_gains)),t=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,e,c.recipient_finalization_active_state.operator_signature);return s.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FINALIZATION,t),s.activeState.latestTransfer.amountsMatched=c.matched_amounts,s.activeState.finalizePendingSwap()?E(i,o):new Promise(function(){return o(wallet_update_error_model_1.WalletUpdateError.SWAP_FINALIZATION_FAILURE)})}return m.contractApi.validateDataActiveState(c,c.recipient_finalization_active_state,c.recipient,u.address,u.contractAddress,u.tokenAddress,f,transfer_model_1.Transfer.FULFILLED_SWAP_MARKER).then(function(e){return e?(s.activeState.latestTransfer.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FINALIZATION,c.recipient_finalization_active_state),c.recipient_finalization_active_state.operator_signature?m.contractApi.validateDataActiveState(c,c.recipient_finalization_active_state,c.recipient,u.contractOwnerAddress,u.contractAddress,u.tokenAddress,f,transfer_model_1.Transfer.FULFILLED_SWAP_MARKER).then(function(e){if(!e)return o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_FINALIZATION_HUB_SIGNATURE_INVALID);var t=active_state_model_1.ActiveState.checksum(u.contractAddress,u.tokenAddress,u.address,u.trailIdentifier,c.eon_number,c.recipient_finalization_active_state.tx_set_hash,new bignumber_js_1.default(c.recipient_finalization_active_state.updated_spendings),new bignumber_js_1.default(c.recipient_finalization_active_state.updated_gains)),r=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,t,c.recipient_finalization_active_state.operator_signature);return s.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FINALIZATION,r),s.activeState.latestTransfer.amountsMatched=c.matched_amounts,s.activeState.finalizePendingSwap()?E(i,o):new Promise(function(){return o(wallet_update_error_model_1.WalletUpdateError.SWAP_FINALIZATION_FAILURE)})}):E(i,o)):o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_FINALIZATION_WALLET_SIGNATURE_INVALID)})},_=function(){if(logging_1.Logging.debug("processSwapFreezing"),c.complete||!c.cancelled)return a();if(!c.swap_freezing_signature)return E(i,o);var _=s.activeState.latestTransfer;c.matched_amounts&&(_.amountsMatched=c.matched_amounts);var t=signature_model_1.Signature.fromRSV(u.address,_.cancellationHash,c.swap_freezing_signature);m.contractApi.validateSignature(t,u.contractAddress).then(function(e){return e?(_.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FREEZING,t),c.sender_cancellation_active_state&&c.recipient_cancellation_active_state?void(n?m.contractApi.validateDataActiveState(c,c.sender_cancellation_active_state,c.wallet,c.wallet.address,u.contractAddress,u.tokenAddress,f,u.getEonSwapStartingBalance(s.eonNumber)).then(function(e){return e?(_.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION,c.sender_cancellation_active_state),c.sender_cancellation_active_state.operator_signature&&c.recipient_cancellation_active_state.operator_signature?m.contractApi.validateDataActiveState(c,c.sender_cancellation_active_state,c.wallet,u.contractOwnerAddress,u.contractAddress,u.tokenAddress,f,u.getEonSwapStartingBalance(s.eonNumber)).then(function(e){if(!e)return o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_SENDER_CANCELLATION_HUB_SIGNATURE_INVALID);_.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.RECIPIENT_CANCELLATION,c.recipient_cancellation_active_state);var t=active_state_model_1.ActiveState.checksum(u.contractAddress,u.tokenAddress,u.address,u.trailIdentifier,c.eon_number,c.sender_cancellation_active_state.tx_set_hash,new bignumber_js_1.default(c.sender_cancellation_active_state.updated_spendings),new bignumber_js_1.default(c.sender_cancellation_active_state.updated_gains)),r=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,t,c.sender_cancellation_active_state.operator_signature);_.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION,r);var a=active_state_model_1.ActiveState.checksum(u.contractAddress,c.recipient.token,c.recipient.address,c.recipient_trail_identifier,c.eon_number,c.recipient_cancellation_active_state.tx_set_hash,new bignumber_js_1.default(c.recipient_cancellation_active_state.updated_spendings),new bignumber_js_1.default(c.recipient_cancellation_active_state.updated_gains)),n=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,a,c.recipient_cancellation_active_state.operator_signature);return _.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.RECIPIENT_CANCELLATION,n),s.activeState.cancelPendingSwap()?E(i,o):o(wallet_update_error_model_1.WalletUpdateError.SWAP_CANCELLATION_FAILURE)}):E(i,o)):o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_SENDER_CANCELLATION_WALLET_SIGNATURE_INVALID)}):m.contractApi.validateDataActiveState(c,c.recipient_cancellation_active_state,c.recipient,c.recipient.address,u.contractAddress,u.tokenAddress,f,transfer_model_1.Transfer.FULFILLED_SWAP_MARKER).then(function(e){return e?(_.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.RECIPIENT_CANCELLATION,c.recipient_cancellation_active_state),c.sender_cancellation_active_state.operator_signature&&c.recipient_cancellation_active_state.operator_signature?m.contractApi.validateDataActiveState(c,c.recipient_cancellation_active_state,c.recipient,u.contractOwnerAddress,u.contractAddress,u.tokenAddress,f,transfer_model_1.Transfer.FULFILLED_SWAP_MARKER).then(function(e){if(!e)return o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_RECIPIENT_CANCELLATION_HUB_SIGNATURE_INVALID);_.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION,c.sender_cancellation_active_state);var t=active_state_model_1.ActiveState.checksum(u.contractAddress,c.wallet.token,c.wallet.address,c.wallet_trail_identifier,c.eon_number,c.sender_cancellation_active_state.tx_set_hash,new bignumber_js_1.default(c.sender_cancellation_active_state.updated_spendings),new bignumber_js_1.default(c.sender_cancellation_active_state.updated_gains)),r=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,t,c.sender_cancellation_active_state.operator_signature);_.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.SENDER_CANCELLATION,r);var a=active_state_model_1.ActiveState.checksum(u.contractAddress,u.tokenAddress,u.address,u.trailIdentifier,c.eon_number,c.recipient_cancellation_active_state.tx_set_hash,new bignumber_js_1.default(c.recipient_cancellation_active_state.updated_spendings),new bignumber_js_1.default(c.recipient_cancellation_active_state.updated_gains)),n=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,a,c.recipient_cancellation_active_state.operator_signature);return _.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.RECIPIENT_CANCELLATION,n),s.activeState.cancelPendingSwap()?E(i,o):o(wallet_update_error_model_1.WalletUpdateError.SWAP_CANCELLATION_FAILURE)}):E(i,o)):o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_RECIPIENT_CANCELLATION_WALLET_SIGNATURE_INVALID)})):E(i,o)):o(wallet_update_error_model_1.WalletUpdateError.INVALID_WALLET_FREEZE_REQUEST_SIGNATURE)})},l=function(){if(logging_1.Logging.debug("processSwapFulfillment"),c.matched_amounts&&(s.activeState.latestTransfer.amountsMatched=c.matched_amounts),!c.complete)return _();if(!c.recipient_fulfillment_active_state||!c.recipient_fulfillment_active_state.operator_signature)return new Promise(function(){return o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_FULFILLMENT_HUB_SIGNATURE_MISSING)});if(n){var e=active_state_model_1.ActiveState.checksum(u.contractAddress,c.recipient.token,c.recipient.address,c.recipient_trail_identifier,c.eon_number,c.recipient_fulfillment_active_state.tx_set_hash,new bignumber_js_1.default(c.recipient_fulfillment_active_state.updated_spendings),new bignumber_js_1.default(c.recipient_fulfillment_active_state.updated_gains)),t=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,e,c.recipient_fulfillment_active_state.operator_signature);return s.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT,t),s.activeState.fulfillPendingSwap()?a():new Promise(function(){return o(wallet_update_error_model_1.WalletUpdateError.SWAP_FULFILLMENT_FAILURE)})}return m.contractApi.validateDataActiveState(c,c.recipient_fulfillment_active_state,c.recipient,u.contractOwnerAddress,u.contractAddress,u.tokenAddress,f,transfer_model_1.Transfer.FULFILLED_SWAP_MARKER).then(function(e){if(!e)return o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_FULFILLMENT_HUB_SIGNATURE_INVALID);var t=active_state_model_1.ActiveState.checksum(u.contractAddress,u.tokenAddress,u.address,u.trailIdentifier,c.eon_number,c.recipient_fulfillment_active_state.tx_set_hash,new bignumber_js_1.default(c.recipient_fulfillment_active_state.updated_spendings),new bignumber_js_1.default(c.recipient_fulfillment_active_state.updated_gains)),r=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,t,c.recipient_fulfillment_active_state.operator_signature);return s.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT,r),s.activeState.fulfillPendingSwap()?a():o(wallet_update_error_model_1.WalletUpdateError.SWAP_FULFILLMENT_FAILURE)})},d=function(){if(logging_1.Logging.debug("processSwapActivation"),!c.sender_active_state.operator_signature||!c.recipient_active_state.operator_signature)return _();var e=active_state_model_1.ActiveState.checksum(u.contractAddress,c.wallet.token,c.wallet.address,c.wallet_trail_identifier,c.eon_number,c.sender_active_state.tx_set_hash,new bignumber_js_1.default(c.sender_active_state.updated_spendings),new bignumber_js_1.default(c.sender_active_state.updated_gains)),t=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,e,c.sender_active_state.operator_signature),r=active_state_model_1.ActiveState.checksum(u.contractAddress,c.recipient.token,c.recipient.address,c.recipient_trail_identifier,c.eon_number,c.recipient_active_state.tx_set_hash,new bignumber_js_1.default(c.recipient_active_state.updated_spendings),new bignumber_js_1.default(c.recipient_active_state.updated_gains)),a=signature_model_1.Signature.fromRSV(u.contractOwnerAddress,r,c.recipient_active_state.operator_signature);return n?m.contractApi.validateDataActiveState(c,c.sender_active_state,c.wallet,u.contractOwnerAddress,u.contractAddress,c.wallet.token,f,u.getEonSwapStartingBalance(s.eonNumber)).then(function(e){return e?(s.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,t),s.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT,a),l()):o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_SWAP_DEBIT_HUB_SIGNATURE_INVALID)}):m.contractApi.validateDataActiveState(c,c.recipient_active_state,c.recipient,u.contractOwnerAddress,u.contractAddress,c.recipient.token,f,u.getEonSwapStartingBalance(s.eonNumber)).then(function(e){return e?(s.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,t),s.activeState.latestTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT,a),l()):o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_SWAP_CREDIT_HUB_SIGNATURE_INVALID)})},t=function(r){return logging_1.Logging.debug("processSwapEnrollment"),c.processed&&c.voided?(s.removePendingIncomingTransfer(c),s.addCancelledTransfer(c),E(i,o)):n?m.contractApi.validateDataActiveState(c,c.sender_active_state,c.wallet,c.wallet.address,u.contractAddress,c.wallet.token,f,u.getEonSwapStartingBalance(s.eonNumber)).then(function(e){if(!e)return o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_SWAP_DEBIT_WALLET_SIGNATURE_INVALID);r&&s.activeState.createOutgoingSwap(c.recipient.address,c.recipient.token,c.recipient_trail_identifier,new bignumber_js_1.default(c.amount),new bignumber_js_1.default(c.amount_swapped),u.getEonSwapStartingBalance(s.eonNumber),new bignumber_js_1.default(c.nonce),c.id);var t=s.activeState.latestTransfer;return t.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT)||t.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,c.sender_active_state),t.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT)||t.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT,c.recipient_active_state),t.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT)||t.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT,c.recipient_fulfillment_active_state),d()}):m.contractApi.validateDataActiveState(c,c.recipient_active_state,c.recipient,c.recipient.address,u.contractAddress,c.recipient.token,f,u.getEonSwapStartingBalance(s.eonNumber)).then(function(e){return e?m.contractApi.validateDataActiveState(c,c.recipient_fulfillment_active_state,c.recipient,u.address,u.contractAddress,u.tokenAddress,f,transfer_model_1.Transfer.FULFILLED_SWAP_MARKER).then(function(e){if(!e)return o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_FULFILLMENT_WALLET_SIGNATURE_INVALID);if(r)s.activeState.createIncomingSwap(c.wallet.address,c.wallet.token,new bignumber_js_1.default(c.amount),new bignumber_js_1.default(c.amount_swapped),u.getEonSwapStartingBalance(s.eonNumber),new bignumber_js_1.default(c.nonce),c.id);var t=s.activeState.latestTransfer;return t.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT)||t.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,c.sender_active_state),t.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT)||t.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT,c.recipient_active_state),t.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT)||t.authorizations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.FULFILLMENT,c.recipient_fulfillment_active_state),d()}):o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_SWAP_CREDIT_WALLET_SIGNATURE_INVALID)})};if(e&&c.id<e.txId)return E(i,o);if(e&&c.id==e.txId)return s.activeState.isTransferPending?e.isSwapFinalized?o(wallet_update_error_model_1.WalletUpdateError.LOGIC_AGGREGATION_FORK):e.isSwapFulfilled?a():e.isSwapActive?l():n&&!util_1.isSameHexValue(s.activeState.transferTree.hash,c.sender_active_state.tx_set_hash)?o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TX_SET_ROOT_INVALID_OUTGOING):n||util_1.isSameHexValue(s.activeState.transferTree.hash,c.recipient_active_state.tx_set_hash)?t(!1):o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TX_SET_ROOT_INVALID_INCOMING):E(i,o);if(c.processed&&c.voided)return s.removePendingIncomingTransfer(c),s.addCancelledTransfer(c),E(i,o);if(s.activeState.isTransferPending)return o(wallet_update_error_model_1.WalletUpdateError.LOGIC_AGGREGATION_FORK);var r=active_state_model_1.ActiveState.fromJSON(s.activeState.json);return r.isTransferPending&&r.cancelPendingTransfer(),n?r.createOutgoingSwap(c.recipient.address,c.recipient.token,c.recipient_trail_identifier,new bignumber_js_1.default(c.amount),new bignumber_js_1.default(c.amount_swapped),u.getEonSwapStartingBalance(s.eonNumber),new bignumber_js_1.default(c.nonce),c.id):r.createIncomingSwap(c.wallet.address,c.wallet.token,new bignumber_js_1.default(c.amount),new bignumber_js_1.default(c.amount_swapped),u.getEonSwapStartingBalance(s.eonNumber),new bignumber_js_1.default(c.nonce),c.id),n&&!util_1.isSameHexValue(r.transferTree.hash,c.sender_active_state.tx_set_hash)?o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TX_SET_ROOT_INVALID_OUTGOING):n||util_1.isSameHexValue(r.transferTree.hash,c.recipient_active_state.tx_set_hash)?t(!0):o(wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TX_SET_ROOT_INVALID_INCOMING)})},e.prototype.updateLatestEonWithdrawalRequests=function(r,e,t){logging_1.Logging.debug("updateLatestEonWithdrawalRequests");var a=t?t.walletData:null;return new Promise(function(e,t){if(!r)return t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!r.isRegistered)return t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);if(!(a&&a.withdrawal_requests&&a.withdrawal_requests.length))return e();if(!r.latestEon)return t(wallet_update_error_model_1.WalletUpdateError.LOCAL_DATA_MISSING_LATEST_EON);r.latestEon;try{return e()}catch(e){return t(e)}})},e.prototype.updateLatestEonOnChainWithdrawal=function(i,o,s){return logging_1.Logging.debug("updateLatestEonOnChainWithdrawal"),new Promise(function(e,t){if(!i)return t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!i.isRegistered)return t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);if(!o)return t(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED);if(!i.latestEon)return t(wallet_update_error_model_1.WalletUpdateError.LOCAL_DATA_MISSING_LATEST_EON);for(var r=[],a=s.walletData.withdrawal_requests,n=0;n<a.length;n++)if(a[n].eon_number===i.latestEon.eonNumber){var _=!o.pendingWithdrawals.some(function(e){return e.eonNumber===a[n].eon_number});r.push(new withdrawal_model_1.Withdrawal(s.walletData.withdrawal_requests[n].eon_number,new bignumber_js_1.default(s.walletData.withdrawal_requests[n].amount),_))}return i.latestEon.setOnChainWithdrawals(r),e()})},e.prototype.updateLatestEonDeposits=function(a,e,t){logging_1.Logging.debug("updateLatestEonDeposits");var n=t?t.walletData:null;return new Promise(function(e,t){if(!a)return t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!a.isRegistered)return t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);if(!n||!n.deposits||!n.deposits.length)return e();var r=a.latestEon;if(!r)return t(wallet_update_error_model_1.WalletUpdateError.LOCAL_DATA_MISSING_LATEST_EON);try{return n.deposits.filter(function(e){return e.eon_number==r.eonNumber}).map(function(e){return new deposit_model_1.Deposit(e.txid,e.block,e.eon_number,new bignumber_js_1.default(e.amount))}).map(function(e){return r.addDeposit(e)}),e()}catch(e){return t(e)}})},e.prototype.updateCurrentEonOnChainDeposits=function(r,a,e){return logging_1.Logging.debug("updateCurrentEonOnChainDeposits"),new Promise(function(e,t){if(!r)return t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!r.isRegistered)return t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);if(!a)return t(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED);try{r.latestEon&&(r.latestEon.onChainDeposit=a.deposits[0]),r.previousEon&&(r.previousEon.onChainDeposit=a.deposits[1]),r.secondPreviousEon&&(r.secondPreviousEon.onChainDeposit=a.deposits[2])}catch(e){return t(e)}return e()})},e.prototype.updateLatestEonDeliveryReceipts=function(_,i,o,s){var l=this;logging_1.Logging.debug("updateLatestEonDeliveryReceipts");var d=o?o.walletData:null;return new Promise(function(e,t){if(!_)return t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!_.isRegistered)return t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);var r=_.latestEon;if(!r)return t(wallet_update_error_model_1.WalletUpdateError.LOCAL_DATA_MISSING_LATEST_EON);if(r.eonNumber==_.registrationEon)return e();if(r.eonNumber==i.currentEonNumber&&!i.isCheckpointSubmitted)return i.currentSubBlock>i.slackPeriod?t(wallet_update_error_model_1.WalletUpdateError.PROVIDER_NOT_AUDITABLE):e();if(s&&_.latestEon.eonNumber==i.currentEonNumber-2)return e();var a=d?d.transfers.filter(function(e){return e.eon_number==r.eonNumber-1}).sort(function(e,t){return e.id-t.id}):[],n=_.previousEon.activeState.transfers;return l.updateDeliveryReceipt(_,n,a,0,i,o,s).then(e).catch(t)})},e.prototype.updateDeliveryReceipt=function(i,o,s,l,d,u,e,c){var p=this;return void 0===c&&(c=!1),logging_1.Logging.debug("updateDeliveryReceipt"),new Promise(function(t,r){if(!i)return r(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!o||l>=o.length)return c?r(wallet_update_error_model_1.WalletUpdateError.REMOTE_DATA_INVALID_DELIVERY_RECEIPT):t();var a=function(e,t,r){return void 0===r&&(r=c),p.updateDeliveryReceipt(i,o,s,l+1,d,u,r).then(e).catch(t)},n=o[l];if(n.deliveryProof)return a(t,r,c);if(util_1.isSameHexValue(i.address,n.recipient))return a(t,r,c);if(n.eonNumber<d.currentEonNumber-d.eonsKept)return a(t,r,c);if(n.isPassive)return logging_1.Logging.debug("!! We are skipping validateDeliveryProof Because passive transfer verification is not supported !!"),a(t,r,c);if(!n.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT)||!n.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT))return r(wallet_update_error_model_1.WalletUpdateError.LOGIC_RECEIPT_VALIDATION_ERROR_MISSING_CONFIRMATION);var _=s.find(function(e){return e.id==n.txId});if(!_||!_.delivery_proof)return logging_1.Logging.error(n),logging_1.Logging.error(s),a(t,r,!0);p.contractApi.validateDeliveryProof(n,_,i.contractAddress,i.tokenAddress,e).then(function(e){return e?(n.saveDeliveryProof(_.delivery_proof),a(t,r,c)):a(t,r,!0)})})},e.prototype.progressEon=function(a,n,e){return logging_1.Logging.debug("progressEon"),new Promise(function(e,t){if(!a)return t(wallet_update_error_model_1.WalletUpdateError.NO_WALLET_SPECIFIED);if(!a.isRegistered)return t(wallet_update_error_model_1.WalletUpdateError.UNREGISTERED);if(!n)return t(wallet_update_error_model_1.WalletUpdateError.NO_CONTRACT_STATE_SPECIFIED);if(a.latestEon.eonNumber===n.currentEonNumber)return t(wallet_update_error_model_1.WalletUpdateError.LOGIC_PREMATURE_EON_ADVANCEMENT);var r=new eon_model_1.Eon(a.contractAddress,a.tokenAddress,a.address,a.trailIdentifier,a.latestEon.eonNumber+1);return a.addEon(r),e()})},e.prototype.updateLightSyncEon=function(a,n,e,_){return new Promise(function(e,t){if(!_||a.latestEon.eonNumber>=n.currentEonNumber-2)return e();var r=new eon_model_1.Eon(a.contractAddress,a.tokenAddress,a.address,a.trailIdentifier,n.currentEonNumber-2);return a.addEonForce(r),e()})},e=__decorate([inversify_1.injectable(),__param(0,inversify_1.inject(inversify_types_1.TYPES.SUBJECT.WALLET_STATE_POLL)),__param(1,inversify_1.inject(inversify_types_1.TYPES.SUBJECT.HUB_STATE_FETCH)),__param(2,inversify_1.inject(inversify_types_1.TYPES.SUBJECT.CONTRACT_STATE_FETCH)),__param(3,inversify_1.inject(inversify_types_1.TYPES.SUBJECT.WALLET_STATE_SYNC)),__param(4,inversify_1.inject(contract_api_service_1.ContractApiService)),__param(5,inversify_1.inject(operator_api_service_1.OperatorApiService)),__metadata("design:paramtypes",[rxjs_1.Observable,rxjs_1.Observable,rxjs_1.Observable,Object,contract_api_service_1.ContractApiService,operator_api_service_1.OperatorApiService])],e)}();exports.WalletStateService=WalletStateService;