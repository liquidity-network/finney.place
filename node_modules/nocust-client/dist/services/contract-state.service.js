"use strict";var __decorate=this&&this.__decorate||function(t,e,r,n){var a,o=arguments.length,c=o<3?e:null===n?n=Object.getOwnPropertyDescriptor(e,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)c=Reflect.decorate(t,e,r,n);else for(var i=t.length-1;0<=i;i--)(a=t[i])&&(c=(o<3?a(c):3<o?a(e,r,c):a(e,r))||c);return 3<o&&c&&Object.defineProperty(e,r,c),c},__metadata=this&&this.__metadata||function(t,e){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(t,e)},__param=this&&this.__param||function(r,n){return function(t,e){n(t,e,r)}},__awaiter=this&&this.__awaiter||function(o,c,i,s){return new(i||(i=Promise))(function(t,e){function r(t){try{a(s.next(t))}catch(t){e(t)}}function n(t){try{a(s.throw(t))}catch(t){e(t)}}function a(e){e.done?t(e.value):new i(function(t){t(e.value)}).then(r,n)}a((s=s.apply(o,c||[])).next())})},__generator=this&&this.__generator||function(r,n){var a,o,c,t,i={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return t={next:e(0),throw:e(1),return:e(2)},"function"==typeof Symbol&&(t[Symbol.iterator]=function(){return this}),t;function e(e){return function(t){return function(e){if(a)throw new TypeError("Generator is already executing.");for(;i;)try{if(a=1,o&&(c=2&e[0]?o.return:e[0]?o.throw||((c=o.return)&&c.call(o),0):o.next)&&!(c=c.call(o,e[1])).done)return c;switch(o=0,c&&(e=[2&e[0],c.value]),e[0]){case 0:case 1:c=e;break;case 4:return i.label++,{value:e[1],done:!1};case 5:i.label++,o=e[1],e=[0];continue;case 7:e=i.ops.pop(),i.trys.pop();continue;default:if(!(c=0<(c=i.trys).length&&c[c.length-1])&&(6===e[0]||2===e[0])){i=0;continue}if(3===e[0]&&(!c||e[1]>c[0]&&e[1]<c[3])){i.label=e[1];break}if(6===e[0]&&i.label<c[1]){i.label=c[1],c=e;break}if(c&&i.label<c[2]){i.label=c[2],i.ops.push(e);break}c[2]&&i.ops.pop(),i.trys.pop();continue}e=n.call(r,i)}catch(t){e=[6,t],o=0}finally{a=c=0}if(5&e[0])throw e[1];return{value:e[0]?e[1]:void 0,done:!0}}([e,t])}}};Object.defineProperty(exports,"__esModule",{value:!0});var inversify_1=require("inversify"),rxjs_1=require("rxjs"),contract_api_service_1=require("./contract-api.service"),inversify_types_1=require("../inversify.types"),contract_state_model_1=require("../models/state/contract-state.model"),logging_1=require("./logging"),wallet_storage_service_1=require("./wallet-storage.service"),ContractStateService=function(){function t(t,e,r,n){var a=this;this.stateUpdatePollObservable=t,this.contractStateFetchObserver=e,this.web3Service=r,this.contractApi=n,this.stateCache=new Map,this.parametersCache=new Map,t.subscribe(function(t){a.fetchContractState(t.wallet).then(function(t){a.contractStateFetchObserver.next(t)})})}return t.prototype.fetchContractState=function(a){var o=this;logging_1.Logging.debug("fetchContractState");var c=new contract_state_model_1.ContractState;return c.timestamp=(new Date).getTime(),this.web3Service.networkId().then(function(t){return c.networkId=t,o.web3Service.latestBlockNumber()}).then(function(t){c.block=t;var e,r=wallet_storage_service_1.WalletStorageService.walletKey(a.address,c.networkId,a.contractAddress,a.tokenAddress),n=r.concat("/",c.block.toString());return o.stateCache.has(n)?((e=o.stateCache.get(n)).timestamp=c.timestamp,e.networkId=c.networkId,e):o.parametersCache.has(r)?((e=o.parametersCache.get(r)).timestamp=c.timestamp,e.networkId=c.networkId,e.block=c.block,o.fetchContractStateVariables(a,e).then(function(t){return o.stateCache.set(n,t),t})):o.fetchContractStateConstants(a,c).then(function(t){return o.parametersCache.set(r,t),o.fetchContractStateVariables(a,t)}).then(function(t){return o.stateCache.set(n,t),t})}).catch(function(t){return logging_1.Logging.error(t),null})},t.prototype.fetchContractStateConstants=function(e,t){var r=this;logging_1.Logging.debug("fetchContractStateConstants");var n=contract_state_model_1.ContractState.fromJSON(t.json);return this.contractApi.genesis(e.contractAddress).then(function(t){return n.genesis=t,r.contractApi.getBlocksPerEon(e.contractAddress)}).then(function(t){return n.blocksPerEon=t,r.contractApi.getChallengeCost(e.contractAddress)}).then(function(t){return n.challengeCost=t,r.contractApi.getSlackPeriod(e.contractAddress)}).then(function(t){return n.slackPeriod=t,r.contractApi.getExtendedSlackPeriod(e.contractAddress)}).then(function(t){return n.extendedSlackPeriod=t,r.contractApi.getEonsKept(e.contractAddress)}).then(function(t){return n.eonsKept=t,r.contractApi.getDepositsKept(e.contractAddress)}).then(function(t){return n.depositsKept=t,n})},t.prototype.fetchContractStateVariables=function(s,l){return __awaiter(this,void 0,void 0,function(){var e,r,n,a,o,c,i;return __generator(this,function(t){switch(t.label){case 0:return logging_1.Logging.debug("fetchContractStateVariables"),e=contract_state_model_1.ContractState.fromJSON(l.json),r=contract_api_service_1.ContractApiService.eonNumberAt(e.block,e.genesis,e.blocksPerEon),!e.currentEonNumber||r>e.currentEonNumber?(n=e,[4,this.contractApi.hasOutstandingChallenges(s.contractAddress)]):[3,2];case 1:n.hasOutstandingChallenges=t.sent(),t.label=2;case 2:return e.currentEonNumber=r,e.currentSubBlock=contract_api_service_1.ContractApiService.subBlockAt(e.block,e.genesis,e.blocksPerEon),[4,this.contractApi.clientContractStateVariables(s.tokenAddress,s.address,s.contractAddress)];case 3:for(a=t.sent(),e.onChainBalance=a.holderBalance,e.deposits[0]=a.currentEonDeposits,e.deposits[1]=a.previousEonDeposits,e.deposits[2]=a.secondPreviousEonDeposits,e.pendingWithdrawals=a.pendingWithdrawals.map(function(t){return{eonNumber:t[0],amount:t[1]}}),e.LatestEonsData=new Array(e.eonsKept).fill({eonNumber:0,merkleRoot:"0x0000000000000000000000000000000000000000",liveChallenges:0}),o=0;o<e.eonsKept&&o<=a.lastCheckpointEonNumber;o++)c=a.lastCheckpointEonNumber-o,i=c%e.eonsKept,e.LatestEonsData[i]={eonNumber:c,merkleRoot:a.merkleRoots[i],liveChallenges:a.liveChallenges[i]};return[2,e]}})})},t=__decorate([inversify_1.injectable(),__param(0,inversify_1.inject(inversify_types_1.TYPES.SUBJECT.WALLET_STATE_POLL)),__param(1,inversify_1.inject(inversify_types_1.TYPES.SUBJECT.CONTRACT_STATE_FETCH)),__param(2,inversify_1.inject(inversify_types_1.TYPES.EXTERNAL.WEB3_SERVICE_INTERFACE)),__param(3,inversify_1.inject(contract_api_service_1.ContractApiService)),__metadata("design:paramtypes",[rxjs_1.Observable,Object,Object,contract_api_service_1.ContractApiService])],t)}();exports.ContractStateService=ContractStateService;