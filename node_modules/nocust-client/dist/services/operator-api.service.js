"use strict";var __decorate=this&&this.__decorate||function(e,t,r,n){var s,i=arguments.length,o=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;0<=a;a--)(s=e[a])&&(o=(i<3?s(o):3<i?s(t,r,o):s(t,r))||o);return 3<i&&o&&Object.defineProperty(t,r,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(r,n){return function(e,t){n(e,t,r)}},__awaiter=this&&this.__awaiter||function(i,o,a,c){return new(a||(a=Promise))(function(e,t){function r(e){try{s(c.next(e))}catch(e){t(e)}}function n(e){try{s(c.throw(e))}catch(e){t(e)}}function s(t){t.done?e(t.value):new a(function(e){e(t.value)}).then(r,n)}s((c=c.apply(i,o||[])).next())})},__generator=this&&this.__generator||function(r,n){var s,i,o,e,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(s)throw new TypeError("Generator is already executing.");for(;a;)try{if(s=1,i&&(o=2&t[0]?i.return:t[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,t[1])).done)return o;switch(i=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return a.label++,{value:t[1],done:!1};case 5:a.label++,i=t[1],t=[0];continue;case 7:t=a.ops.pop(),a.trys.pop();continue;default:if(!(o=0<(o=a.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){a=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){a.label=t[1];break}if(6===t[0]&&a.label<o[1]){a.label=o[1],o=t;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(t);break}o[2]&&a.ops.pop(),a.trys.pop();continue}t=n.call(r,a)}catch(e){t=[6,e],i=0}finally{s=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var util_1=require("./../util"),inversify_1=require("inversify"),inversify_types_1=require("../inversify.types"),util_2=require("../util"),isomorphic_ws_1=__importDefault(require("isomorphic-ws")),operators_1=require("rxjs/operators"),logging_1=require("./logging");require("reflect-metadata");var SocketMessageType,TransactionSocketMessageType,https_proxy_agent_1=__importDefault(require("https-proxy-agent")),rxjs_1=require("rxjs"),async_mutex_1=require("async-mutex"),WS_RECONNECT_INIT_INTERVAL=500,WS_RECONNECT_INCREASE=2,WS_HEALTH_CHECK_INTERVAL=5e3,WS_PING_MESSAGE="x",WS_PING_RESPONSE_MESSAGE="o";!function(e){e.INCOMING_TRANSFER="incoming_transfer",e.INCOMING_RECEIPT="incoming_receipt",e.INCOMING_CONFIRMATION="incoming_confirmation",e.INCOMING_TIMEOUT="timeout_transfer",e.MATCHED_SWAP="matched_swap",e.FINALIZED_SWAP="finalized_swap",e.REGISTERED_WALLET="registered_wallet"}(SocketMessageType=exports.SocketMessageType||(exports.SocketMessageType={})),function(e){e.INCOMING_TRANSFER="incoming_transfer",e.INCOMING_RECEIPT="incoming_receipt",e.INCOMING_CONFIRMATION="incoming_confirmation",e.INCOMING_TIMEOUT="timeout_transfer",e.MATCHED_SWAP="matched_swap",e.FINALIZED_SWAP="finalized_swap"}(TransactionSocketMessageType=exports.TransactionSocketMessageType||(exports.TransactionSocketMessageType={}));var OperatorApiService=function(){function e(e){this.api=e,this.subscribedAddresses=[],this.webSocketUrl="",this.webSocketReconnectInterval=WS_RECONNECT_INIT_INTERVAL,this.syncMessageObserver=new rxjs_1.Subject,this.walletSubscriptionLock=new async_mutex_1.Mutex}return e.prototype.getStatusData=function(e){return this.api.get(e,"audit/")},e.prototype.getTokensList=function(e){return this.api.get(e,"audit/tokens/")},e.prototype.getWalletData=function(e,t,r,n,s){return void 0===n&&(n=0),void 0===s&&(s=0),this.api.get(r,"audit/"+util_2.remove0xPrefix(t)+"/"+util_2.remove0xPrefix(e)+"/","eon_number="+n+"&transfer_id="+s)},e.prototype.whoisWallet=function(e,t,r){return this.api.get(r,"audit/"+util_2.remove0xPrefix(e)+"/"+util_2.remove0xPrefix(t)+"/whois")},e.prototype.getTransfersFromTxId=function(e,t){return this.api.get(t,"transfer/"+e.toString())},e.prototype.getSwapOrders=function(e,t,r,n){return this.api.get(r,"audit/swaps/"+util_2.remove0xPrefix(e)+"/"+util_2.remove0xPrefix(t),n?"eon_number="+n:null)},e.prototype.register=function(e,t){return this.api.post(e.webAddress,"admission/",{token:util_2.remove0xPrefix(e.tokenAddress),address:util_2.remove0xPrefix(e.address),authorization:t.rsv})},e.prototype.getSLADetails=function(e){return this.api.get(e.webAddress,"sla/")},e.prototype.getSLAStatus=function(e){return this.api.get(e.webAddress,"sla/"+util_2.remove0xPrefix(e.address))},e.prototype.sendTransfer=function(e,t,r,n){return this.api.post(e.webAddress,"transfer/",{wallet_signature:{value:r.rsv},wallet_balance_signature:{value:n.rsv},eon_number:t.transfer.eonNumber,amount:t.transfer.amount,passive:t.transfer.isPassive,wallet_balance:t.markerBalance.toFixed(0),nonce:t.transfer.nonce,wallet:{address:util_2.remove0xPrefix(t.transfer.sender),token:util_2.remove0xPrefix(e.tokenAddress)},recipient:util_2.remove0xPrefix(t.transfer.recipient)})},e.prototype.sendSwap=function(e,t,r,n,s,i,o){return this.api.post(e.webAddress,"swap/",{debit_signature:{value:n.rsv},debit_balance_signature:{value:o.rsv},credit_signature:{value:s.rsv},fulfillment_signature:{value:i.rsv},eon_number:r.senderTransfer.eonNumber,amount:r.senderTransfer.amount,amount_swapped:r.senderTransfer.amountSwapped,nonce:r.senderTransfer.nonce,debit_balance:r.balanceMarker.toFixed(0),wallet:{address:e.address,token:e.tokenAddress},recipient:{address:t.address,token:t.tokenAddress}})},e.prototype.sendSwapFreeze=function(e,t,r){return this.api.put(e.webAddress,"swap/"+t.txId+"/freeze",{freezing_signature:{value:r.rsv}})},e.prototype.sendSwapCancellation=function(e,t,r,n){return this.api.put(e.webAddress,"swap/"+t.txId+"/cancel",{sender_cancellation_signature:{value:r.rsv},recipient_cancellation_signature:{value:n.rsv}})},e.prototype.sendSwapFinalization=function(e,t,r){return this.api.put(e.webAddress,"swap/"+t.txId+"/finalize",{finalization_signature:{value:r.rsv}})},e.prototype.sendReceipt=function(e,t,r){return this.api.put(e.webAddress,"transfer/"+t+"/",{wallet_signature:{value:r.rsv}})},e.prototype.isWebSocketConnectionOpen=function(){return!(!this.socket||this.socket.readyState!==this.socket.OPEN)},e.prototype.toWebSocketUrl=function(e){if(e.endsWith("/")||(e+="/"),e.startsWith("https://"))return"wss://"+e.slice(8);if(e.startsWith("http://"))return"ws://"+e.slice(7);if(e.startsWith("ws://")||e.startsWith("wss://"))return e;throw Error("Unknown protocol")},e.prototype.initSocket=function(i,o){var a=this;return new Promise(function(e,t){var r=a;if(r.webSocketUrl=r.toWebSocketUrl(o),process&&process.env&&(process.env.HTTPS_PROXY||process.env.https_proxy)){var n=process.env.HTTPS_PROXY||process.env.https_proxy,s=new https_proxy_agent_1.default(n);r.socket=new isomorphic_ws_1.default(r.webSocketUrl+"sync/wallets/",{agent:s})}else r.socket=new isomorphic_ws_1.default(r.webSocketUrl+"sync/wallets/");r.socket.onclose=function(e){logging_1.Logging.log("Socket closed, reopen..."+e),setTimeout(function(){return r.initSocket(i,o)},r.webSocketReconnectInterval),r.webSocketReconnectInterval*=WS_RECONNECT_INCREASE,r.webSocketHealthCheck&&clearInterval(r.webSocketHealthCheck)},r.socket.onerror=function(e){logging_1.Logging.log("Socket error, reopen..."+e)},r.socket.onopen=function(){r.webSocketReconnectInterval=WS_RECONNECT_INIT_INTERVAL,a.subscribeToWallet(i).then(function(){return e()}),r.webSocketHealthCheck=setInterval(function(){return r.socket.send(WS_PING_MESSAGE)},WS_HEALTH_CHECK_INTERVAL)},r.socket.onmessage=function(e){if(r.webSocketReconnectInterval=WS_RECONNECT_INIT_INTERVAL,e.data!==WS_PING_RESPONSE_MESSAGE){var t=util_1.JSONbig.parse(e.data);if("success"===t.status){if(r.subscribedAddresses=t.message.wallets.map(function(e){return util_1.add0xPrefix(e)}),!a.pendingWalletSubscriptionResolve)throw new Error("Unexpected success registration message");a.pendingWalletSubscriptionResolve(r.subscribedAddresses),a.pendingWalletSubscriptionResolve=void 0}else"notify"===t.status&&r.syncMessageObserver.next(t)}}})},e.prototype.subscribeToWallet=function(n){return __awaiter(this,void 0,void 0,function(){var t=this;return __generator(this,function(e){return[2,this.walletSubscriptionLock.runExclusive(function(){return new Promise(function(r,e){return __awaiter(t,void 0,void 0,function(){var t;return __generator(this,function(e){return this.pendingWalletSubscriptionResolve=r,t=util_1.removeDuplicateFromArray(Array.from(this.subscribedAddresses).concat([n]).map(function(e){return util_2.remove0xPrefix(e)})),this.socket.send(JSON.stringify({action:"subscribe",wallets:t})),[2]})})})})]})})},e.prototype.initiateSocketAndSubscribeWallet=function(t,r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return this.socket?[3,2]:[4,this.initSocket(t,r)];case 1:e.sent(),e.label=2;case 2:if(this.webSocketUrl!==this.toWebSocketUrl(r))throw Error("Hub api url inconsistent");return this.subscribedAddresses.find(function(e){return e===t})||this.socket.readyState!==this.socket.OPEN?[3,4]:[4,this.subscribeToWallet(t)];case 3:e.sent(),e.label=4;case 4:return[2]}})})},e.prototype.registerOperatorRegistrationWebSocketNotificationCallback=function(r){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.initiateSocketAndSubscribeWallet(r.walletAddress,r.webAddress)];case 1:return e.sent(),[2,this.syncMessageObserver.pipe(operators_1.map(function(e){return e.message}),operators_1.filter(function(e){if(!util_2.isSameHexValue(e.topic,r.walletAddress))return!1;if(SocketMessageType.REGISTERED_WALLET!==e.type)return!1;var t=e.data;return!r.tokenAddress||util_2.isSameHexValue(t.token,r.tokenAddress)}),operators_1.map(function(e){return e.data}))]}})})},e.prototype.registerTransferWebSocketNotificationCallback=function(i){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,this.initiateSocketAndSubscribeWallet(i.walletAddress,i.webAddress)];case 1:return e.sent(),[2,this.syncMessageObserver.pipe(operators_1.map(function(e){return e.message}),operators_1.filter(function(e){if(!util_2.isSameHexValue(e.topic,i.walletAddress))return!1;if(e.type!==SocketMessageType.INCOMING_CONFIRMATION&&e.type!==SocketMessageType.INCOMING_RECEIPT&&e.type!==SocketMessageType.INCOMING_TIMEOUT&&e.type!==SocketMessageType.INCOMING_TRANSFER&&e.type!==SocketMessageType.FINALIZED_SWAP&&e.type!==SocketMessageType.MATCHED_SWAP)return!1;if(i.socketMessageType&&i.socketMessageType!==e.type)return!1;var t=e.data,r=!1;r=!i.tokenAddress||util_2.isSameHexValue(t.wallet.token,i.tokenAddress);var n=!1;n=!i.txId||i.txId===t.id;var s=!0;return i.nonce&&(s=i.nonce===t.nonce),n&&r&&s}),operators_1.map(function(e){return e.data}))]}})})},e=__decorate([inversify_1.injectable(),__param(0,inversify_1.inject(inversify_types_1.TYPES.EXTERNAL.REST_API_INTERFACE)),__metadata("design:paramtypes",[Object])],e)}();exports.OperatorApiService=OperatorApiService;