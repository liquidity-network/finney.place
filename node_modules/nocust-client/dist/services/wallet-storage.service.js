"use strict";var __decorate=this&&this.__decorate||function(e,t,r,n){var a,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var o=e.length-1;0<=o;o--)(a=e[o])&&(s=(i<3?a(s):3<i?a(t,r,s):a(t,r))||s);return 3<i&&s&&Object.defineProperty(t,r,s),s},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(r,n){return function(e,t){n(e,t,r)}},__awaiter=this&&this.__awaiter||function(i,s,o,l){return new(o||(o=Promise))(function(e,t){function r(e){try{a(l.next(e))}catch(e){t(e)}}function n(e){try{a(l.throw(e))}catch(e){t(e)}}function a(t){t.done?e(t.value):new o(function(e){e(t.value)}).then(r,n)}a((l=l.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(r,n){var a,i,s,e,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=n.call(r,o)}catch(e){t=[6,e],i=0}finally{a=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var inversify_1=require("inversify"),inversify_types_1=require("../inversify.types"),wallet_model_1=require("../models/wallet/wallet.model"),util_1=require("../util"),logging_1=require("./logging"),WalletStorageService=function(){function e(e){this.storage=e}var u;return(u=e).prototype.saveWallet=function(a){return __awaiter(this,void 0,void 0,function(){var t,r,n;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,3,,4]),t=u.walletInstanceKey(a),[4,this.storage.set(t,util_1.JSONbig.stringify(a.json))];case 1:return r=e.sent(),[4,this.addToIndex(a)];case 2:return e.sent(),[2,r];case 3:return n=e.sent(),logging_1.Logging.error(n),[2,!1];case 4:return[2]}})})},e.prototype.loadWallet=function(i,s,o,l){return __awaiter(this,void 0,void 0,function(){var t,r,n,a;return __generator(this,function(e){switch(e.label){case 0:return e.trys.push([0,5,,6]),t=u.walletKey(i,s,o,l),[4,this.storage.get(t)];case 1:return(r=e.sent())?[3,3]:[4,this.removeFromIndex(new wallet_model_1.Wallet(i,s,null,o,l,null))];case 2:return e.sent(),[2,null];case 3:return n=wallet_model_1.Wallet.fromJSON(util_1.JSONbig.parse(r)),[4,this.addToIndex(n)];case 4:return e.sent(),[2,n];case 5:return a=e.sent(),logging_1.Logging.error(a),[2,null];case 6:return[2]}})})},e.prototype.wallets=function(){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.storage.get(u.INDEX_KEY)];case 1:return(t=e.sent())?[2,new Map(util_1.JSONbig.parse(t))]:[2,new Map]}})})},e.prototype.addToIndex=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.wallets()];case 1:return(t=e.sent()).set(u.walletInstanceKey(r),{address:r.address,networkId:r.networkId,contractAddress:r.contractAddress,webAddress:r.webAddress,tokenAddress:r.tokenAddress}),this.storage.set(u.INDEX_KEY,util_1.JSONbig.stringify(Array.from(t.entries()))),[2]}})})},e.prototype.removeFromIndex=function(r){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,this.wallets()];case 1:return(t=e.sent()).delete(u.walletInstanceKey(r)),this.storage.set(u.INDEX_KEY,util_1.JSONbig.stringify(Array.from(t.entries()))),[2]}})})},e.walletInstanceKey=function(e){return u.walletKey(e.address,e.networkId,e.contractAddress,e.tokenAddress)},e.walletKey=function(e,t,r,n){return util_1.Web3Utils.soliditySha3({type:"address",value:e},{type:"uint256",value:t},{type:"address",value:r},{type:"address",value:n})},e.INDEX_KEY="lqd-wallet-client-index",e=u=__decorate([inversify_1.injectable(),__param(0,inversify_1.inject(inversify_types_1.TYPES.EXTERNAL.STORAGE_MANAGER_INTERFACE)),__metadata("design:paramtypes",[Object])],e)}();exports.WalletStorageService=WalletStorageService;