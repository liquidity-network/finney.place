"use strict";var __decorate=this&&this.__decorate||function(e,t,i,r){var n,o=arguments.length,a=o<3?t:null===r?r=Object.getOwnPropertyDescriptor(t,i):r;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,r);else for(var u=e.length-1;0<=u;u--)(n=e[u])&&(a=(o<3?n(a):3<o?n(t,i,a):n(t,i))||a);return 3<o&&a&&Object.defineProperty(t,i,a),a},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(i,r){return function(e,t){r(e,t,i)}},__awaiter=this&&this.__awaiter||function(o,a,u,s){return new(u||(u=Promise))(function(e,t){function i(e){try{n(s.next(e))}catch(e){t(e)}}function r(e){try{n(s.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(i,r)}n((s=s.apply(o,a||[])).next())})},__generator=this&&this.__generator||function(i,r){var n,o,a,e,u={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;u;)try{if(n=1,o&&(a=2&t[0]?o.return:t[0]?o.throw||((a=o.return)&&a.call(o),0):o.next)&&!(a=a.call(o,t[1])).done)return a;switch(o=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,o=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(a=0<(a=u.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){u.label=t[1];break}if(6===t[0]&&u.label<a[1]){u.label=a[1],a=t;break}if(a&&u.label<a[2]){u.label=a[2],u.ops.push(t);break}a[2]&&u.ops.pop(),u.trys.pop();continue}t=r.call(i,u)}catch(e){t=[6,e],o=0}finally{n=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),require("reflect-metadata");var inversify_1=require("inversify"),inversify_types_1=require("../inversify.types"),proof_of_exclusive_allotment_model_1=require("../models/primitives/proof-of-exclusive-allotment.model"),nocust_commit_chain_abi_1=require("../models/nocust-commit-chain.abi"),util_1=require("../util"),eon_model_1=require("../models/wallet/eon.model"),signature_model_1=require("../models/primitives/signature.model"),bignumber_js_1=__importDefault(require("bignumber.js")),active_state_model_1=require("../models/transactions/active-state.model"),transfer_model_1=require("../models/transactions/transfer.model"),logging_1=require("./logging"),erc20_abi_1=require("../models/erc20-abi"),ethUtil=require("ethereumjs-util"),SLASH_GAS_COST=new bignumber_js_1.default(100100),ContractApiService=function(){function e(e){this.web3Service=e,this.contracts=new Map}var a;return(a=e).prototype.getABI=function(e,t){return void 0===t&&(t=nocust_commit_chain_abi_1.NOCUST_COMMIT_CHAIN_ABI),this.contracts.has(e)||this.contracts.set(e,this.web3Service.getContractAt(t,e)),this.contracts.get(e)},e.prototype.genesis=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.genesis().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.getLiveChallenges=function(i,r){var n=this;return new Promise(function(e,t){n.getABI(r).methods.getLiveChallenges(i).call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.currentEonNumber=function(n){var o=this;return new Promise(function(r,e){o.web3Service.latestBlockNumber().then(function(i){return o.genesis(n).then(function(t){return o.getBlocksPerEon(n).then(function(e){return r(a.eonNumberAt(i,t,e))})})}).catch(e)})},e.eonNumberAt=function(e,t,i){return Math.floor((e-t)/i)+1},e.prototype.nextBlockEon=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.currentEon().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.currentSubBlock=function(n){var o=this;return new Promise(function(r,e){o.web3Service.latestBlockNumber().then(function(i){return o.genesis(n).then(function(t){return o.getBlocksPerEon(n).then(function(e){return r(a.subBlockAt(i,t,e))})})}).catch(e)})},e.subBlockAt=function(e,t,i){return(e-t)%i},e.prototype.nextBlockSubBlock=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.currentEra().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.lastSubmissionEon=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.lastSubmissionEon().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.balance=function(i,r){var n=this;return void 0===r&&(r=null),r?new Promise(function(e,t){n.getABI(r,erc20_abi_1.ERC20_ABI).methods.balanceOf(util_1.add0xPrefix(i)).call(util_1.promiseExecutorCallback(e,t))}).then(util_1.bigNumberValueOfResult):this.web3Service.balanceOf(i)},e.prototype.allowance=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(i,erc20_abi_1.ERC20_ABI).methods.allowance(util_1.add0xPrefix(r),util_1.add0xPrefix(n)).call(util_1.promiseExecutorCallback(e,t))}).then(util_1.bigNumberValueOfResult)},e.prototype.pendingWithdrawals=function(i,r,n,o){var a=this;return new Promise(function(e,t){a.getABI(o).methods.getPendingWithdrawalsAtSlot(util_1.add0xPrefix(i),r%n).call(util_1.promiseExecutorCallback(e,t))}).then(util_1.bigNumberValueOfResult)},e.prototype.getBlocksPerEon=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.BLOCKS_PER_EON().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.getSlackPeriod=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.BLOCKS_PER_EPOCH().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.getExtendedSlackPeriod=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.EXTENDED_BLOCKS_PER_EPOCH().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.getEonsKept=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.EONS_KEPT().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.getDepositsKept=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.DEPOSITS_KEPT().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.intValueOfResult)},e.prototype.getChallengeCost=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.MIN_CHALLENGE_GAS_COST().call(util_1.promiseExecutorCallback(e,t))}).then(util_1.bigNumberValueOfResult)},e.prototype.recordBook=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.getIsWalletRecovered(util_1.add0xPrefix(i),r).call(util_1.promiseExecutorCallback(e,t))})},e.prototype.checkpoint=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(r).methods.getCheckpointAtSlot(i%n).call(util_1.promiseExecutorCallback(e,t))}).then(util_1.valueOfResult)},e.prototype.clientContractStateVariables=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.getClientContractStateVariables(util_1.add0xPrefix(i),r).call(util_1.promiseExecutorCallback(e,t))}).then(function(e){return{lastCheckpointEonNumber:util_1.intValueOfResult(e[0]),merkleRoots:e[1],liveChallenges:e[2].map(function(e){return util_1.intValueOfResult(e)}),currentEonDeposits:util_1.bigNumberValueOfResult(e[3]),previousEonDeposits:util_1.bigNumberValueOfResult(e[4]),secondPreviousEonDeposits:util_1.bigNumberValueOfResult(e[5]),pendingWithdrawals:e[6].filter(function(e){return"0"!==e[0]}).map(function(e){return[util_1.intValueOfResult(e[0]),util_1.bigNumberValueOfResult(e[1])]}),holderBalance:util_1.bigNumberValueOfResult(e[7])}})},e.prototype.metamaskHashFix=function(e){return this.web3Service.currentProvider.isMetaMask?util_1.Web3Utils.soliditySha3("Ethereum Signed Message:\n32",e):e},e.prototype.vrs=function(e){var t=util_1.remove0xPrefix(e),i=parseInt(t.slice(128,130),16);return i<27&&(i+=27),t.slice(0,128)+i.toString(16)},e.prototype.signPersonal=function(t,i){return this.web3Service.signPersonalMessage(t,i).then(function(e){return signature_model_1.Signature.fromRSV(i,t,e)})},e.prototype.signInternalWithPrivateKey=function(n,o,a){return __awaiter(this,void 0,void 0,function(){var t,i,r;return __generator(this,function(e){return t=Buffer.from(util_1.remove0xPrefix(util_1.lqdWrapper(n)),"hex"),i=ethUtil.hashPersonalMessage(t),r=ethUtil.ecsign(i,new Buffer(util_1.remove0xPrefix(a),"hex")),[2,signature_model_1.Signature.fromRSV(o,n,ethUtil.toRpcSig(r.v,r.r,r.s))]})})},e.prototype.signRaw=function(e,t,i){void 0===i&&(i=null);var r=this.metamaskHashFix(e);return this.web3Service.signRawDigest(r,t).then(function(e){return signature_model_1.Signature.fromRSV(t,r,e)})},e.prototype.sign=function(e,t){return this.web3Service.canSignPersonal?this.signPersonal(t,e):this.signRaw(t,e)},e.prototype.recoverSigningAddress=function(i,r,e){var n=this;return void 0===e&&(e=!1),e?this.recoverSigningAddressLocal(i):new Promise(function(e,t){n.getABI(r).methods.signedMessageECRECOVER(i.checksum,util_1.add0xPrefix(i.r),util_1.add0xPrefix(i.s),util_1.add0xPrefix(i.v)).call(util_1.promiseExecutorCallback(e,t))})},e.prototype.validateActiveStateSignature=function(t,e,i){return this.verifyProofOfTransitionAgreement(t.tokenAddress,t.walletAddress,t.trailIdentifier,t.eonNumber,t.transferTree.hash,t.spent,t.gained,e,i).then(function(e){return e&&util_1.isSameHexValue(e.toString(),t.hash)}).catch(function(e){return logging_1.Logging.error("Transition Agreement Check Rejected: "+e),!1})},e.prototype.validateDataActiveState=function(u,s,l,c,d,f,_,g){var m=this;return logging_1.Logging.debug("validateDataActiveState"),new Promise(function(t,e){var i=util_1.isSameHexValue(l.address,u.wallet.address)&&util_1.isSameHexValue(l.token,u.wallet.token),r=i?u.wallet_trail_identifier:u.recipient_trail_identifier,n=i?u.recipient:u.wallet,o=active_state_model_1.ActiveState.checksum(d,f,l.address,r,u.eon_number,s.tx_set_hash,new bignumber_js_1.default(s.updated_spendings),new bignumber_js_1.default(s.updated_gains)),a=util_1.isSameHexValue(c,l.address)?signature_model_1.Signature.fromRSV(c,o,s.wallet_signature):signature_model_1.Signature.fromRSV(c,o,s.operator_signature);m.verifyProofOfTransitionAgreement(f,l.address,r,u.eon_number,s.tx_set_hash,new bignumber_js_1.default(s.updated_spendings),new bignumber_js_1.default(s.updated_gains),a,d).then(function(e){if(!util_1.isSameHexValue(e,o))return t(!1);logging_1.Logging.debug(e),g?m.verifyProofOfSwapAggregationRaw(u.wallet.token,u.recipient.token,s.tx_set_index,s.tx_set_proof,new bignumber_js_1.default(u.amount),new bignumber_js_1.default(u.amount_swapped),g,u.recipient_trail_identifier,new bignumber_js_1.default(u.nonce),s.tx_set_hash,d,_).then(t):m.verifyProofOfTransferAggregationRaw(s.tx_set_index,s.tx_set_proof,n.address,new bignumber_js_1.default(u.amount),u.recipient_trail_identifier,new bignumber_js_1.default(u.nonce),s.tx_set_hash,d,!1,null,_).then(t)}).catch(e)})},e.prototype.validateTransferDebit=function(n,o,a,u,s){var l=this;return logging_1.Logging.debug("validateTransferDebit"),new Promise(function(t,e){var i=active_state_model_1.ActiveState.checksum(a,u,n.wallet.address,n.wallet_trail_identifier,n.eon_number,n.sender_active_state.tx_set_hash,new bignumber_js_1.default(n.sender_active_state.updated_spendings),new bignumber_js_1.default(n.sender_active_state.updated_gains)),r=util_1.isSameHexValue(o,n.wallet.address)?signature_model_1.Signature.fromRSV(o,i,n.sender_active_state.wallet_signature):signature_model_1.Signature.fromRSV(o,i,n.sender_active_state.operator_signature);l.verifyProofOfTransitionAgreement(u,n.wallet.address,n.wallet_trail_identifier,n.eon_number,n.sender_active_state.tx_set_hash,new bignumber_js_1.default(n.sender_active_state.updated_spendings),new bignumber_js_1.default(n.sender_active_state.updated_gains),r,a).then(function(e){if(!util_1.isSameHexValue(e,i))return t(!1);logging_1.Logging.debug(e),l.verifyProofOfTransferAggregationRaw(n.sender_active_state.tx_set_index,n.sender_active_state.tx_set_proof,n.recipient.address,new bignumber_js_1.default(n.amount),n.recipient_trail_identifier,new bignumber_js_1.default(n.nonce),n.sender_active_state.tx_set_hash,a,n.passive,new bignumber_js_1.default(n.position),s).then(t)}).catch(e)})},e.prototype.validateTransferCredit=function(n,o,a,u,s){var l=this;return logging_1.Logging.debug("validateTransferCredit"),new Promise(function(t,e){if(n.passive)return t(!1);var i=active_state_model_1.ActiveState.checksum(a,u,n.recipient.address,n.recipient_trail_identifier,n.eon_number,n.recipient_active_state.tx_set_hash,new bignumber_js_1.default(n.recipient_active_state.updated_spendings),new bignumber_js_1.default(n.recipient_active_state.updated_gains)),r=util_1.isSameHexValue(o,n.recipient.address)?signature_model_1.Signature.fromRSV(o,i,n.recipient_active_state.wallet_signature):signature_model_1.Signature.fromRSV(o,i,n.recipient_active_state.operator_signature);l.verifyProofOfTransitionAgreement(u,n.recipient.address,n.recipient_trail_identifier,n.eon_number,n.recipient_active_state.tx_set_hash,new bignumber_js_1.default(n.recipient_active_state.updated_spendings),new bignumber_js_1.default(n.recipient_active_state.updated_gains),r,a).then(function(e){if(!util_1.isSameHexValue(e,i))return t(!1);logging_1.Logging.debug(e),l.verifyProofOfTransferAggregationRaw(n.recipient_active_state.tx_set_index,n.recipient_active_state.tx_set_proof,n.wallet.address,new bignumber_js_1.default(n.amount),n.recipient_trail_identifier,new bignumber_js_1.default(n.nonce),n.recipient_active_state.tx_set_hash,a,n.passive,new bignumber_js_1.default(n.position),s).then(t)}).catch(e)})},e.prototype.validateDeliveryProof=function(s,i,l,c,d){var f=this;return logging_1.Logging.debug("validateDeliveryProof"),new Promise(function(n,o){var e=new eon_model_1.Eon(l,c,s.recipient,s.recipientTrailIdentifier,s.eonNumber+1),a=i.delivery_proof,u=a.merkle_proof,t=new proof_of_exclusive_allotment_model_1.ProofOfExclusiveAllotment(l,c,s.recipient,u.active_state_checksum,s.recipientTrailIdentifier,s.eonNumber+1,u.allotment_chain,u.membership_chain,u.values.map(function(e){return new bignumber_js_1.default(e)}),new bignumber_js_1.default(u.left),new bignumber_js_1.default(u.right),u.passive_checksum,new bignumber_js_1.default(u.passive_amount),new bignumber_js_1.default(u.passive_marker));f.verifyProof(e,t).then(function(e){if(!e)return logging_1.Logging.error("Invalid recipient proof of exclusive allotment"),n(!1);var r=a.final_active_state;f.getOperatorAccountAddress(l).then(function(e){var i=active_state_model_1.ActiveState.checksum(l,c,s.recipient,s.recipientTrailIdentifier,s.eonNumber,r.tx_set_hash,new bignumber_js_1.default(r.updated_spendings),new bignumber_js_1.default(r.updated_gains));if(!util_1.isSameHexValue(i,u.active_state_checksum))return logging_1.Logging.error(i),logging_1.Logging.error(u.active_state_checksum),logging_1.Logging.error("Mismatching activeStateChecksum."),n(!1);var t=signature_model_1.Signature.fromRSV(e,i,r.operator_signature);f.verifyProofOfTransitionAgreement(c,s.recipient,s.recipientTrailIdentifier,s.eonNumber,r.tx_set_hash,new bignumber_js_1.default(r.updated_spendings),new bignumber_js_1.default(r.updated_gains),t,l).then(function(e){if(!util_1.isSameHexValue(e,i))return logging_1.Logging.error("Mismatching activeState checksumTransfer by operator"),logging_1.Logging.error(e),logging_1.Logging.error(i),n(!1);var t=signature_model_1.Signature.fromRSV(s.recipient,i,r.wallet_signature);f.verifyProofOfTransitionAgreement(c,s.recipient,s.recipientTrailIdentifier,s.eonNumber,r.tx_set_hash,new bignumber_js_1.default(r.updated_spendings),new bignumber_js_1.default(r.updated_gains),t,l).then(function(e){if(!util_1.isSameHexValue(e,i))return logging_1.Logging.error("Mismatching activeState checksumTransfer by wallet"),logging_1.Logging.error(e),logging_1.Logging.error(i),n(!1);f.verifyProofOfTransferAggregationRaw(a.transfer_membership_trail,a.transfer_membership_chain,s.sender,s.amount,s.recipientTrailIdentifier,s.nonce,r.tx_set_hash,l,s.isPassive,s.passiveOffset,d).then(n)}).catch(o)}).catch(o)})}).catch(o)})},e.prototype.validateSignature=function(t,e){return this.recoverSigningAddress(t,e).then(function(e){return util_1.isSameHexValue(e,t.address)}).catch(function(){return!1})},e.prototype.getOperatorAccountAddress=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.operator().call(util_1.promiseExecutorCallback(e,t))})},e.prototype.validateOperatorSignature=function(e,i){var r=this;return this.getOperatorAccountAddress(i).then(function(t){return r.recoverSigningAddress(e,i).then(function(e){return util_1.isSameHexValue(e,t)})}).catch(function(){return!1})},e.prototype.doNothingOnce=function(i,r,n,o){var a=this;return new Promise(function(e,t){a.getABI(r).methods.doNothing.send({from:i,gas:o,gasPrice:n.toFixed(0)},util_1.promiseExecutorCallback(e,t))})},e.prototype.doNothing=function(r,n,o,a,u){var t=this;return new Promise(function(i,e){return __awaiter(t,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:t=0,e.label=1;case 1:return t<r?[4,this.doNothingOnce(n,o,a,u)]:[3,4];case 2:e.sent(),e.label=3;case 3:return t++,[3,1];case 4:return i(!0),[2]}})})})},e.prototype.getDeposits=function(i,r,n,o,a){var u=this;return new Promise(function(e,t){if(r<1)return e(void 0);u.getABI(a).methods.getDepositsAtSlot(o,i,r%n).call(util_1.promiseExecutorCallback(e,t))}).then(function(e){return e&&e[0].valueOf()==r?new bignumber_js_1.default(e[1].valueOf()):new bignumber_js_1.default(0)})},e.prototype.getTotalDepositAtSlot=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.getWalletDepositActiveStateAtSlot(r,i).call(util_1.promiseExecutorCallback(e,t))}).then(function(e){return new bignumber_js_1.default(e[1].valueOf())})},e.prototype.getTotalDepositEonAtSlot=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.getWalletDepositActiveStateAtSlot(r,i).call(util_1.promiseExecutorCallback(e,t))}).then(function(e){return e[0].valueOf()})},e.prototype.getPendingWithdrawalsAtSlot=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.getPendingWithdrawalsAtSlot(r,i).call(util_1.promiseExecutorCallback(e,t))}).then(function(e){return new bignumber_js_1.default(e[1].valueOf())})},e.prototype.getPendingWithdrawalsEonAtSlot=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.getPendingWithdrawalsAtSlot(r,i).call(util_1.promiseExecutorCallback(e,t))}).then(function(e){return e[0].valueOf()})},e.prototype.getConfirmedWithdrawalsAtSlot=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.getConfirmedWithdrawalsAtSlot(r,i).call(util_1.promiseExecutorCallback(e,t))}).then(function(e){return new bignumber_js_1.default(e[1].valueOf())})},e.prototype.getConfirmedWithdrawalsEonAtSlot=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.getConfirmedWithdrawalsAtSlot(r,i).call(util_1.promiseExecutorCallback(e,t))}).then(function(e){return e[0].valueOf()})},e.prototype.deposit=function(i,r,n,o,e,t,a){var u=this,s=util_1.isSameHexValue(i,o)?{value:r.toFixed(0),from:n,gasPrice:e.toFixed(0),gas:t,nonce:a}:{value:0,from:n,gasPrice:e.toFixed(0),gas:t,nonce:a};return new Promise(function(e,t){u.getABI(o).methods.deposit(util_1.add0xPrefix(i),n,r.toFixed(0)).send(s,util_1.promiseExecutorCallback(e,t))})},e.prototype.enableERC20Deposits=function(i,r,n,o,a,u){var s=this;return new Promise(function(e,t){s.getABI(i,erc20_abi_1.ERC20_ABI).methods.approve(util_1.add0xPrefix(n),new bignumber_js_1.default(2).pow(256).minus(1).toFixed(0)).send({from:r,gasPrice:o.toFixed(0),gas:a,nonce:u},util_1.promiseExecutorCallback(e,t))})},e.prototype.requestWithdrawal=function(i,r,n,o,a,u,s){var l=this;return new Promise(function(e,t){l.getABI(o).methods.requestWithdrawal(n.tokenAddress,[n.activeStateChecksum,n.passiveChecksum],n.trail,n.allotmentChain.map(function(e){return util_1.add0xPrefix(e)}),n.membershipChain.map(function(e){return util_1.add0xPrefix(e)}),n.values.map(function(e){return e.toFixed(0)}),[[n.left.toFixed(0),n.right.toFixed(0)],[n.passiveAmount.toFixed(0),n.passiveMarker.toFixed(0)]],i.toFixed(0)).send({from:r,value:a.multipliedBy(SLASH_GAS_COST).toFixed(0),gas:s,gasPrice:u.toFixed(0)},util_1.promiseExecutorCallback(e,t))})},e.prototype.confirmWithdrawal=function(i,r,n,o,a){var u=this;return new Promise(function(e,t){u.getABI(n).methods.confirmWithdrawal(util_1.add0xPrefix(i),util_1.add0xPrefix(r)).send({from:r,gasPrice:o.toFixed(0),gas:a},util_1.promiseExecutorCallback(e,t))})},e.prototype.hasOutstandingChallenges=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.hasOutstandingChallenges().call(util_1.promiseExecutorCallback(e,t))})},e.prototype.hasMissedCheckpointSubmission=function(i){var r=this;return new Promise(function(e,t){r.getABI(i).methods.hasMissedCheckpointSubmission().call(util_1.promiseExecutorCallback(e,t))})},e.prototype.isPunished=function(r){var n=this;return new Promise(function(t,i){n.hasOutstandingChallenges(r).then(function(e){return e?t(!0):n.hasMissedCheckpointSubmission(r).then(t).catch(i)}).catch(i)})},e.prototype.estimateChallengeInitialEmptyStateCost=function(r,n,o,a,u,s,l,c){var d=this;return logging_1.Logging.debug("estimateChallengeInitialEmptyStateCost"),new Promise(function(t,i){d.balance(n).then(function(e){d.getABI(c).methods.challengeStateUpdateWithProofOfActiveStateUpdateAgreement(r,a,o,[u.toFixed(0),s.toFixed(0)],util_1.add0xPrefix(l.r),util_1.add0xPrefix(l.s),util_1.add0xPrefix(l.v)).estimateGas({from:n,value:e.toFixed(0)},util_1.promiseExecutorCallback(t,i))}).catch(i)})},e.prototype.submitChallengeInitialEmptyState=function(i,r,n,o,a,u,s,l,c,d,f){var _=this;return logging_1.Logging.debug("submitChallengeInitialEmptyState"),new Promise(function(e,t){_.getABI(c).methods.challengeStateUpdateWithProofOfActiveStateUpdateAgreement(i,o,n,[a.toFixed(0),u.toFixed(0)],util_1.add0xPrefix(s.r),util_1.add0xPrefix(s.s),util_1.add0xPrefix(s.v)).send({from:r,value:l.toFixed(0),gasPrice:d.toFixed(0),gas:f},util_1.promiseExecutorCallback(e,t))})},e.prototype.estimateChallengeInitialMerkleStateCost=function(r,n,o,a,u,s,l){var c=this;return logging_1.Logging.debug("estimateChallengeInitialMerkleStateCost"),new Promise(function(t,i){c.balance(r).then(function(e){c.getABI(l).methods.challengeStateUpdateWithProofOfExclusiveBalanceAllotment(n.tokenAddress,[n.activeStateChecksum,n.passiveChecksum],n.trail,n.allotmentChain.map(function(e){return util_1.add0xPrefix(e)}),n.membershipChain.map(function(e){return util_1.add0xPrefix(e)}),n.values.map(function(e){return e.toFixed(0)}),[[n.left.toFixed(0),n.right.toFixed(0)],[a.toFixed(0),u.toFixed(0)],[n.passiveAmount.toFixed(0),n.passiveMarker.toFixed(0)]],[util_1.add0xPrefix(s.r),util_1.add0xPrefix(s.s),o],util_1.add0xPrefix(s.v)).estimateGas({from:r,value:e.toFixed(0)},util_1.promiseExecutorCallback(t,i))}).catch(i)})},e.prototype.submitChallengeInitialMerkleState=function(i,r,n,o,a,u,s,l,c,d){var f=this;return logging_1.Logging.debug("submitChallengeInitialMerkleState"),new Promise(function(e,t){f.getABI(l).methods.challengeStateUpdateWithProofOfExclusiveBalanceAllotment(r.tokenAddress,[r.activeStateChecksum,r.passiveChecksum],r.trail,r.allotmentChain.map(function(e){return util_1.add0xPrefix(e)}),r.membershipChain.map(function(e){return util_1.add0xPrefix(e)}),r.values.map(function(e){return e.toFixed(0)}),[[r.left.toFixed(0),r.right.toFixed(0)],[o.toFixed(0),a.toFixed(0)],[r.passiveAmount.toFixed(0),r.passiveMarker.toFixed(0)]],[util_1.add0xPrefix(u.r),util_1.add0xPrefix(u.s),n],util_1.add0xPrefix(u.v)).send({from:i,value:s.toFixed(0),gasPrice:c.toFixed(0),gas:d},util_1.promiseExecutorCallback(e,t))})},e.prototype.estimateDeliveryCommitmentCost=function(r,n,o,a,u,s,l,c,d,f,_,g,m,p,h){var x=this;return logging_1.Logging.debug("estimateDeliveryCommitmentCost"),new Promise(function(t,i){x.balance(n).then(function(e){x.getABI(h).methods.challengeTransferDeliveryWithProofOfActiveStateUpdateAgreement(util_1.add0xPrefix(r),[util_1.add0xPrefix(o),util_1.add0xPrefix(a)],[u.toFixed(0),m.toFixed(0)],[s,l,c],d.map(function(e){return util_1.add0xPrefix(e)}),[_.toFixed(0),g.toFixed(0)],[util_1.add0xPrefix(p.r),util_1.add0xPrefix(p.s),util_1.add0xPrefix(f)],util_1.add0xPrefix(p.v)).estimateGas({from:n,value:e.toFixed(0)},util_1.promiseExecutorCallback(t,i))}).catch(i)})},e.prototype.submitDeliveryCommitment=function(i,r,n,o,a,u,s,l,c,d,f,_,g,m,p,h,x,v){var b=this;return logging_1.Logging.debug("submitDeliveryCommitment"),new Promise(function(e,t){b.getABI(h).methods.challengeTransferDeliveryWithProofOfActiveStateUpdateAgreement(util_1.add0xPrefix(i),[util_1.add0xPrefix(n),util_1.add0xPrefix(o)],[a.toFixed(0),g.toFixed(0)],[u,s,l],c.map(function(e){return util_1.add0xPrefix(e)}),[f.toFixed(0),_.toFixed(0)],[util_1.add0xPrefix(m.r),util_1.add0xPrefix(m.s),util_1.add0xPrefix(d)],util_1.add0xPrefix(m.v)).send({from:r,value:p.toFixed(0),gasPrice:x.toFixed(0),gas:v},util_1.promiseExecutorCallback(e,t))})},e.prototype.getChallengeBook=function(i,r,n,o){var a=this;return new Promise(function(e,t){a.getABI(o).methods.getChallenge(util_1.add0xPrefix(i),r,n).call(util_1.promiseExecutorCallback(e,t))})},e.prototype.verifyProofOfTransferAggregationRaw=function(i,r,e,t,n,o,a,u,s,l,c){var d=this;void 0===l&&(l=null),logging_1.Logging.debug("verifyProofOfTransferAggregationRaw");var f=transfer_model_1.Transfer.checksumTransfer(e,t,n,o,s,l);return c?s?(logging_1.Logging.debug("!! We are skipping verifyProofOfTransferAggregationRaw for passive transfer because not supported !!"),Promise.resolve(!0)):this.verifyProofOfMembershipLocal(i,r.map(function(e){return util_1.add0xPrefix(e)}),util_1.add0xPrefix(f),util_1.add0xPrefix(a)):s?(logging_1.Logging.debug("!! We are skipping verifyProofOfTransferAggregationRaw for passive transfer because not supported !!"),Promise.resolve(!0)):new Promise(function(e,t){d.getABI(u).methods.verifyProofOfMembership(i,r.map(function(e){return util_1.add0xPrefix(e)}),util_1.add0xPrefix(f),util_1.add0xPrefix(a)).call(util_1.promiseExecutorCallback(e,t))})},e.prototype.verifyProofOfSwapAggregationRaw=function(e,t,i,r,n,o,a,u,s,l,c,d){var f=this;logging_1.Logging.debug("verifyProofOfSwapAggregationRaw"),logging_1.Logging.debug([e,t,i,r,n,o,a,u,s,l,c]);var _=transfer_model_1.Transfer.checksumSwap(e,t,u,n,o,a,s);return d?this.verifyProofOfMembershipLocal(i,r.map(function(e){return util_1.add0xPrefix(e)}),util_1.add0xPrefix(_),util_1.add0xPrefix(l)):new Promise(function(e,t){f.getABI(c).methods.verifyProofOfMembership(i,r.map(function(e){return util_1.add0xPrefix(e)}),util_1.add0xPrefix(_),util_1.add0xPrefix(l)).call(util_1.promiseExecutorCallback(e,t))})},e.prototype.verifyProofOfTransitionAgreement=function(i,r,n,o,a,u,s,l,c,e){var d=this;return void 0===e&&(e=!0),logging_1.Logging.debug("verifyProofOfTransitionAgreement"),logging_1.Logging.debug([util_1.add0xPrefix(i),util_1.add0xPrefix(r),n,o,util_1.add0xPrefix(a),[u.toFixed(0),s.toFixed(0)],util_1.add0xPrefix(l.address),util_1.add0xPrefix(l.r),util_1.add0xPrefix(l.s),util_1.add0xPrefix(l.v)]),e?this.verifyProofOfTransitionAgreementLocal(i,r,n,o,a,u,s,l,c):new Promise(function(e,t){d.getABI(c).methods.verifyProofOfActiveStateUpdateAgreement(util_1.add0xPrefix(i),util_1.add0xPrefix(r),n,o,util_1.add0xPrefix(a),[u.toFixed(0),s.toFixed(0)],util_1.add0xPrefix(l.address),util_1.add0xPrefix(l.r),util_1.add0xPrefix(l.s),util_1.add0xPrefix(l.v)).call(util_1.promiseExecutorCallback(e,t))}).then(util_1.valueOfResult)},e.prototype.verifyProof=function(e,t){return logging_1.Logging.debug("verifyProof"),this.verifyProofRaw(e.tokenAddress,e.walletAddress,t.activeStateChecksum,t.trail,e.eonNumber,t.allotmentChain,t.membershipChain,t.values.map(function(e){return e.toFixed(0)}),t.left.toFixed(0),t.right.toFixed(0),t.passiveChecksum,t.passiveAmount.toFixed(0),t.passiveMarker.toFixed(0),e.contractAddress)},e.prototype.verifyProofRaw=function(i,r,n,o,a,u,s,l,c,d,f,_,g,m){var p=this;return logging_1.Logging.debug("verifyProofRaw"),logging_1.Logging.debug([util_1.add0xPrefix(i),util_1.add0xPrefix(r),[util_1.add0xPrefix(n),util_1.add0xPrefix(f)],o,[a,_,g],u,s,l,[c,d]]),new Promise(function(e,t){p.getABI(m).methods.verifyProofOfExclusiveAccountBalanceAllotment(util_1.add0xPrefix(i),util_1.add0xPrefix(r),[util_1.add0xPrefix(n),util_1.add0xPrefix(f)],o,[a,_,g],u,s,l,[c,d]).call(util_1.promiseExecutorCallback(e,t))})},e.prototype.getStateUpdateEvents=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).events.StateUpdate({filter:{token:util_1.add0xPrefix(i),account:r},fromBlock:0,toBlock:"latest"},util_1.promiseExecutorCallback(e,t))})},e.prototype.getStateUpdateEventAtEon=function(i,r,n,o){var a=this;return new Promise(function(e,t){a.getABI(o).events.StateUpdate({filter:{token:util_1.add0xPrefix(i),account:r,eonNumber:n},fromBlock:0,toBlock:"latest"},util_1.promiseExecutorCallback(e,t))})},e.prototype.recoverOnlyOnChainFunds=function(i,r,n,o,a){var u=this;return new Promise(function(e,t){u.getABI(n).methods.recoverOnlyParentChainFunds(util_1.add0xPrefix(i)).send({from:r,gasPrice:o.toFixed(0),gas:a},util_1.promiseExecutorCallback(e,t))})},e.prototype.getReclaimableOnChainFunds=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(n).methods.recoverOnlyParentChainFunds(util_1.add0xPrefix(i)).call({from:r},util_1.promiseExecutorCallback(e,t))}).then(util_1.bigNumberValueOfResult)},e.prototype.recoverAllFunds=function(i,r,n){var o=this;return new Promise(function(e,t){o.getABI(i.contractAddress).methods.recoverAllFunds(i.tokenAddress,i.activeStateChecksum,i.trail,i.allotmentChain,i.membershipChain,i.values.map(function(e){return e.toFixed(0)}),[i.left.toFixed(0),i.right.toFixed(0)]).send({from:i.walletAddress,gasPrice:r.toFixed(0),gas:n},util_1.promiseExecutorCallback(e,t))})},e.prototype.getAllReclaimableFunds=function(i){var r=this;return new Promise(function(e,t){r.getABI(i.contractAddress).methods.recoverAllFunds(util_1.add0xPrefix(i.tokenAddress),util_1.add0xPrefix(i.activeStateChecksum),i.trail,i.allotmentChain.map(function(e){return util_1.add0xPrefix(e)}),i.membershipChain.map(function(e){return util_1.add0xPrefix(e)}),i.values.map(function(e){return e.toFixed(0)}),[i.left.toFixed(0),i.right.toFixed(0)]).call({from:i.walletAddress},util_1.promiseExecutorCallback(e,t))}).then(util_1.bigNumberValueOfResult)},e.prototype.verifyProofOfTransitionAgreementLocal=function(r,n,o,a,u,s,l,c,d){return __awaiter(this,void 0,void 0,function(){var t,i;return __generator(this,function(e){switch(e.label){case 0:return t=active_state_model_1.ActiveState.checksum(d,r,n,o,a,u,s,l),[4,this.recoverSigningAddressLocal(c)];case 1:if(i=e.sent(),util_1.isSameHexValue(c.address,i))return[2,t];throw new Error("signature verification failed, recovered address: "+util_1.add0xPrefix(i)+" expected: "+util_1.add0xPrefix(c.address))}})})},e.prototype.recoverSigningAddressLocal=function(i){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=util_1.lqdWrapper(this.metamaskHashFix(i.checksum)),[4,this.web3Service.rpc.eth.accounts.recover(util_1.add0xPrefix(t),util_1.add0xPrefix(i.v),util_1.add0xPrefix(i.r),util_1.add0xPrefix(i.s))];case 1:return[2,e.sent()]}})})},e.prototype.verifyProofOfMembershipLocal=function(r,n,o,a){return __awaiter(this,void 0,void 0,function(){var t,i;return __generator(this,function(e){for(t=0;t<n.length;t++)i=!1,0<r&&(i=r%2==1,r=Math.floor(r/2)),o=util_1.Web3Utils.soliditySha3({type:"uint32",value:t},{type:"bytes32",value:i?n[t]:o},{type:"bytes32",value:i?o:n[t]});return[2,util_1.isSameHexValue(o,a)]})})},e.prototype.verifyProofLocal=function(e,t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2]})})},e=a=__decorate([inversify_1.injectable(),__param(0,inversify_1.inject(inversify_types_1.TYPES.EXTERNAL.WEB3_SERVICE_INTERFACE)),__metadata("design:paramtypes",[Object])],e)}();exports.ContractApiService=ContractApiService;