"use strict";var __decorate=this&&this.__decorate||function(e,t,r,n){var a,i=arguments.length,o=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)o=Reflect.decorate(e,t,r,n);else for(var s=e.length-1;0<=s;s--)(a=e[s])&&(o=(i<3?a(o):3<i?a(t,r,o):a(t,r))||o);return 3<i&&o&&Object.defineProperty(t,r,o),o},__metadata=this&&this.__metadata||function(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)},__param=this&&this.__param||function(r,n){return function(e,t){n(e,t,r)}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0});var inversify_1=require("inversify"),contract_api_service_1=require("./contract-api.service"),eon_model_1=require("../models/wallet/eon.model"),signature_model_1=require("../models/primitives/signature.model"),proof_of_exclusive_allotment_model_1=require("../models/primitives/proof-of-exclusive-allotment.model"),wallet_update_error_model_1=require("../models/state/wallet-update-error.model"),util_1=require("../util"),bignumber_js_1=__importDefault(require("bignumber.js")),active_state_model_1=require("../models/transactions/active-state.model"),logging_1=require("./logging"),transfer_active_state_update_type_model_1=require("../models/transactions/transfer-active-state-update-type.model"),DisputeService=function(){function e(e){this.contractApi=e}var d;return(d=e).prototype.canIssueStateUpdateChallenge=function(e,t){var r=this;return e.lock.runExclusive(function(){return r.canIssueStateUpdateChallengeInternal(e,t)})},e.prototype.canIssueStateUpdateChallengeInternal=function(a,i){var t=this;return new Promise(function(n,e){t.contractApi.getChallengeBook(a.tokenAddress,a.address,a.address,a.contractAddress).then(function(e){var t=0<parseInt(e[0].valueOf(),10),r=parseInt(e[2].valueOf(),10);return!a.isRegistered||a.isPendingRegistrationApproval?(logging_1.Logging.error("reason 1"),n(!1)):a.registrationEon>=i.currentEonNumber?(logging_1.Logging.error("reason 2"),n(!1)):!a.previousEon||a.previousEon.eonNumber<i.currentEonNumber-1?(logging_1.Logging.error("reason 3"),n(!1)):a.registrationEon<a.previousEon.eonNumber&&!a.previousEon.proofOfExclusiveAllotment?(logging_1.Logging.error("reason 4"),n(!1)):a.previousEon.activeState.lastConfirmedTransfer&&!a.previousEon.activeState.lastConfirmedTransfer.confirmations.get(util_1.isSameHexValue(a.previousEon.activeState.lastConfirmedTransfer.sender,a.address)?transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT:transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT)?(logging_1.Logging.error("reason 5"),n(!1)):t||r>=i.currentEonNumber-1?(logging_1.Logging.error("reason 6"),n(!1)):i.currentSubBlock<i.slackPeriod?(logging_1.Logging.error("reason 7"),n(!1)):i?i.networkId!=a.networkId?(logging_1.Logging.error("reason 9"),n(!1)):n(!i.isPunished):(logging_1.Logging.error("reason 8"),n(!1))})})},e.prototype.canRecoverAllFunds=function(e,t){var r=this;return e.lock.runExclusive(function(){return r.canRecoverAllFundsInternal(e,t)})},e.prototype.canRecoverAllFundsInternal=function(a,i){var o=this;return new Promise(function(r,n){return o.contractApi.recordBook(a.tokenAddress,a.address,a.contractAddress).then(function(e){var t=i.lastSubmissionEon-1;return!a.isRegistered||a.isPendingRegistrationApproval?(logging_1.Logging.error("canRecoverAllFunds reason 1"),r(!1)):a.registrationEon>=t?(logging_1.Logging.error("canRecoverAllFunds reason 2"),r(!1)):a.getEon(t)&&a.getEon(t).proofOfExclusiveAllotment?e?(logging_1.Logging.error("canRecoverAllFunds reason 4"),r(!1)):i.networkId!=a.networkId?(logging_1.Logging.error("reason 9"),r(!1)):o.contractApi.getAllReclaimableFunds(a.getEon(t).proofOfExclusiveAllotment).then(function(e){return r(!e.isZero())}).catch(n):(logging_1.Logging.error("canRecoverAllFunds reason 3"),r(!1))})})},e.prototype.canRecoverOnChainFunds=function(e,t){var r=this;return e.lock.runExclusive(function(){return r.canRecoverOnChainFundsInternal(e,t)})},e.prototype.canRecoverOnChainFundsInternal=function(n,a){var i=this;return new Promise(function(t,r){return i.contractApi.recordBook(n.tokenAddress,n.address,n.contractAddress).then(function(e){return a.deposits?e?(logging_1.Logging.error("canRecoverOnChainFunds reason 3"),t(!1)):a.networkId!=n.networkId?(logging_1.Logging.error("reason 9"),t(!1)):void i.contractApi.getReclaimableOnChainFunds(n.tokenAddress,n.address,n.contractAddress).then(function(e){return t(!e.isZero())}).catch(r):(logging_1.Logging.error("canRecoverOnChainFunds reason 1"),t(!1))})})},e.prototype.issueStateUpdateChallenge=function(s,l,c,g){var u=this;return s.lock.runExclusive(function(){return new Promise(function(i,o){u.canIssueStateUpdateChallengeInternal(s,l).then(function(e){if(!e)return i(!1);var t=s.previousEon.activeState.isTransferPending,r=t?eon_model_1.Eon.fromJSON(s.previousEon.json):s.previousEon;t&&r.activeState.cancelPendingTransfer();var n=r.activeState.lastConfirmedTransfer,a=n?n.confirmations.get(util_1.isSameHexValue(n.sender,s.address)?transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT:transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT):signature_model_1.Signature.EMPTY;r.eonNumber!=s.registrationEon||n||(a=s.registrationApproval),logging_1.Logging.log(r.proofOfExclusiveAllotment),logging_1.Logging.log(r.activeState.trailIdentifier),logging_1.Logging.log(r.activeState.hash),logging_1.Logging.log(a.checksum),logging_1.Logging.log(a.json),n&&u.contractApi.verifyProofOfTransitionAgreement(s.tokenAddress,s.address,s.trailIdentifier,r.eonNumber,r.activeState.transferTree.hash,r.activeState.spent,r.activeState.gained,a,s.contractAddress).then(function(e){logging_1.Logging.log("res"),logging_1.Logging.log(e)}).catch(function(e){logging_1.Logging.error("bad"),logging_1.Logging.error(e)}),r.proofOfExclusiveAllotment?(a===signature_model_1.Signature.EMPTY&&n&&logging_1.Logging.error("Empty signature on activeState."),u.contractApi.estimateChallengeInitialMerkleStateCost(s.address,r.proofOfExclusiveAllotment,r.activeState.transferTree.hash,r.activeState.spent,r.activeState.gained,a,s.contractAddress).then(function(e){logging_1.Logging.log("estimateChallengeInitialMerkleStateCost: "+e),u.contractApi.submitChallengeInitialMerkleState(s.address,r.proofOfExclusiveAllotment,r.activeState.transferTree.hash,r.activeState.spent,r.activeState.gained,a,l.challengeCost.multipliedBy(e),s.contractAddress,c,g).then(i).catch(o)}).catch(o)):u.contractApi.estimateChallengeInitialEmptyStateCost(s.tokenAddress,s.address,s.trailIdentifier,r.activeState.transferTree.hash,r.activeState.spent,r.activeState.gained,a,s.contractAddress).then(function(e){logging_1.Logging.log("estimateChallengeInitialEmptyStateCost: "+e),u.contractApi.submitChallengeInitialEmptyState(s.tokenAddress,s.address,s.trailIdentifier,r.activeState.transferTree.hash,r.activeState.spent,r.activeState.gained,a,l.challengeCost.multipliedBy(e),s.contractAddress,c,g).then(i).catch(o)}).catch(o)})})})},e.prototype.checkStateUpdateChallengeResponse=function(g,e){var u=this;return new Promise(function(o,e){var s,l,c=g.latestEon.eonNumber;u.contractApi.getStateUpdateEventAtEon(g.tokenAddress,g.address,c,g.contractAddress).then(function(e){if(!e||!e.length)return o(null);var t=e.find(function(e){return util_1.isSameHexValue(e.args.account,g.address)&&e.args.eonNumber.toNumber()==c});if(!t||!t.args)return o(null);var r=t.args;logging_1.Logging.log("answer"),logging_1.Logging.log(r),s=new proof_of_exclusive_allotment_model_1.ProofOfExclusiveAllotment(g.contractAddress,g.tokenAddress,g.address,r.activeStateChecksum,r.trail.toNumber(),c,r.allotmentChain,r.membershipChain,r.values.map(function(e){return new bignumber_js_1.default(e)}),r.LR[0],r.LR[1],r.passiveChecksum,r.lrDeltasPassiveMark[2][0],r.lrDeltasPassiveMark[2][1]);var n=util_1.remove0xPrefix(r.r.toString(16)),a=util_1.remove0xPrefix(r.s.toString(16)),i=util_1.remove0xPrefix(r.v.toString(16));return l=signature_model_1.Signature.fromRSV(g.contractOwnerAddress,r.activeStateChecksum,[n,a,i].join("")),u.contractApi.verifyProof(g.getEon(c),s)}).then(function(e){if(!e)throw wallet_update_error_model_1.WalletUpdateError.PROOF_OF_EXCLUSIVE_ALLOTMENT_INVALID;return util_1.isSameHexValue(l.checksum,util_1.EMPTY_HASH)||u.contractApi.validateOperatorSignature(l,g.contractAddress)}).then(function(e){if(!e)throw wallet_update_error_model_1.WalletUpdateError.ACTIVE_STATE_TRANSFER_CREDIT_HUB_SIGNATURE_INVALID;return o([s,l])}).catch(e)})},e.prototype.resolveOnChainStateUpdateDispute=function(e,t,r){var n=this;return e.lock.runExclusive(function(){return n.resolveOnChainStateUpdateDisputeInternal(e,t,r)})},e.prototype.resolveOnChainStateUpdateDisputeInternal=function(o,s,l){var e=this;return new Promise(function(r,n){if(o.latestEon.proofOfExclusiveAllotment)return r(wallet_update_error_model_1.WalletUpdateError.LOGIC_PROOF_ALREADY_UPDATED);if(!s||!l)return n(wallet_update_error_model_1.WalletUpdateError.REMOTE_DATA_MISSING_MERKLE_PROOF);var a=o.latestEon,i=o.previousEon;e.contractApi.verifyProof(a,s).then(function(e){if(!e)return n(wallet_update_error_model_1.WalletUpdateError.PROOF_OF_EXCLUSIVE_ALLOTMENT_INVALID);if(s.amount.isLessThan(i.expectedBalance))return n(wallet_update_error_model_1.WalletUpdateError.PROOF_OF_EXCLUSIVE_ALLOTMENT_INSUFFICIENT_BALANCE);if(a.setProofOfExclusiveAllotment(s),util_1.isSameHexValue(s.activeStateChecksum,i.activeState.hash)){if(i.activeState.isTransferPending)!util_1.isSameHexValue(i.activeState.pendingTransfer.recipient,o.address)?(i.activeState.pendingTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT,l),i.activeState.confirmPendingOutgoingTransfer()):(i.activeState.pendingTransfer.confirmations.set(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.CREDIT,l),i.activeState.confirmPendingIncomingTransfer());return r(wallet_update_error_model_1.WalletUpdateError.REMOTE_DATA_MISSING_MERKLE_PROOF)}if(i.activeState.isTransferPending){var t=active_state_model_1.ActiveState.fromJSON(i.activeState.json);if(t.cancelPendingTransfer(),util_1.isSameHexValue(s.activeStateChecksum,t.hash))return i.activeState.cancelPendingTransfer(),r(wallet_update_error_model_1.WalletUpdateError.LOGIC_TRANSFER_CONFIRM_ERROR)}return r(wallet_update_error_model_1.WalletUpdateError.LOGIC_UNKNOWN)}).catch(n)})},e.canIssueDeliveryChallenge=function(e,t,r){return!!r&&(!r.isPunished&&(!!t.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT)&&(!!t.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT)&&(!(!util_1.isSameHexValue(e.address,t.sender)&&!util_1.isSameHexValue(e.address,t.recipient))&&(t.eonNumber==r.currentEonNumber-1&&!(r.currentSubBlock<r.slackPeriod))))))},e.prototype.issueDeliveryChallenge=function(o,s,l,c,g){var u=this;return o.lock.runExclusive(function(){return new Promise(function(t,r){if(!d.canIssueDeliveryChallenge(o,s,l))return r(new Error);var n=util_1.isSameHexValue(o.address,s.sender),a=s.authorizations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT),i=s.confirmations.get(transfer_active_state_update_type_model_1.TransferActiveStateUpdateType.DEBIT);u.contractApi.estimateDeliveryCommitmentCost(o.tokenAddress,o.address,s.sender,s.recipient,s.nonce,n?o.trailIdentifier:s.recipientTrailIdentifier,a.tx_set_index,s.recipientTrailIdentifier,a.tx_set_proof,a.tx_set_hash,new bignumber_js_1.default(a.updated_spendings),new bignumber_js_1.default(a.updated_gains),s.amount,i,o.contractAddress).then(function(e){logging_1.Logging.log("estimateDeliveryCommitmentCost: "+e),u.contractApi.submitDeliveryCommitment(o.tokenAddress,o.address,s.sender,s.recipient,s.nonce,n?o.trailIdentifier:s.recipientTrailIdentifier,a.tx_set_index,s.recipientTrailIdentifier,a.tx_set_proof,a.tx_set_hash,new bignumber_js_1.default(a.updated_spendings),new bignumber_js_1.default(a.updated_gains),s.amount,i,l.challengeCost.multipliedBy(e),o.contractAddress,c,g).then(t).catch(r)}).catch(r)})})},e=d=__decorate([inversify_1.injectable(),__param(0,inversify_1.inject(contract_api_service_1.ContractApiService)),__metadata("design:paramtypes",[contract_api_service_1.ContractApiService])],e)}();exports.DisputeService=DisputeService;