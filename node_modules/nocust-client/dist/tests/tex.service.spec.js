"use strict";var __awaiter=this&&this.__awaiter||function(a,c,u,o){return new(u||(u=Promise))(function(e,t){function r(e){try{s(o.next(e))}catch(e){t(e)}}function n(e){try{s(o.throw(e))}catch(e){t(e)}}function s(t){t.done?e(t.value):new u(function(e){e(t.value)}).then(r,n)}s((o=o.apply(a,c||[])).next())})},__generator=this&&this.__generator||function(r,n){var s,a,c,e,u={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(s)throw new TypeError("Generator is already executing.");for(;u;)try{if(s=1,a&&(c=2&t[0]?a.return:t[0]?a.throw||((c=a.return)&&c.call(a),0):a.next)&&!(c=c.call(a,t[1])).done)return c;switch(a=0,c&&(t=[2&t[0],c.value]),t[0]){case 0:case 1:c=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,a=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(c=0<(c=u.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){u.label=t[1];break}if(6===t[0]&&u.label<c[1]){u.label=c[1],c=t;break}if(c&&u.label<c[2]){u.label=c[2],u.ops.push(t);break}c[2]&&u.ops.pop(),u.trys.pop();continue}t=n.call(r,u)}catch(e){t=[6,e],a=0}finally{s=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0}),require("reflect-metadata");var chai_1=require("chai");require("mocha");var chai_as_promised_1=__importDefault(require("chai-as-promised")),inversify_container_1=require("../inversify.container"),inversify_types_1=require("../inversify.types"),util_1=require("../util"),tex_service_1=require("../services/tex.service"),nocust_manager_1=require("../nocust-manager"),bignumber_js_1=__importDefault(require("bignumber.js")),logging_1=require("../services/logging");describe("Tex Service",function(){chai_1.use(chai_as_promised_1.default);var S,u,T,x=process.env.TEST_HUB_URL||"http://localhost:8123/",r=process.env.RPC_URL||"http://localhost:8545/",y="0x9561C133DD8580860B6b7E504bC5Aa500f0f06a7",N="0xe982E462b094850F12AF94d21D470e21bE9D0E9C",B="0x90F8bf6A479f320ead074411a4B0e7944Ea8c9C1",C="0xFFcf8FDEE72ac11b5c542428B35EEF5769C409f0",E="0x22d491Bde2303f2f43325b2108D26f1eAbA1e32b";T=new nocust_manager_1.NOCUSTManager({rpcApi:util_1.getWeb3HttpProvider(r),operatorApiUrl:x,contractAddress:y}),beforeEach(function(){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return t=inversify_container_1.NOCUSTClassFactory.createDefaultClassContainer(util_1.getWeb3HttpProvider(r)),S=t.get(tex_service_1.TexService),u=t.get(inversify_types_1.TYPES.EXTERNAL.WEB3_SERVICE_INTERFACE),[4,T.isAddressRegistered(C)];case 1:return e.sent()?[3,3]:[4,T.registerAddress(C)];case 2:e.sent(),e.label=3;case 3:return[4,T.isAddressRegistered(E)];case 4:return e.sent()?[3,6]:[4,T.registerAddress(E)];case 5:e.sent(),e.label=6;case 6:return[4,T.isAddressRegistered(C,N)];case 7:return e.sent()?[3,9]:[4,T.registerAddress(C,N)];case 8:e.sent(),e.label=9;case 9:return[4,T.isAddressRegistered(E,N)];case 10:return e.sent()?[3,12]:[4,T.registerAddress(E,N)];case 11:e.sent(),e.label=12;case 12:return[2]}})})}),it("should return seed (default message)",function(){return __awaiter(_this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,u.accounts];case 1:return t=e.sent()[1],[4,S.getSubAccountSeed(t)];case 2:return r=e.sent(),chai_1.expect(r).to.be.equal("c276a50311c978a78b296d33a11039284745009ae90da8eec37dca6571b2e870"),[2]}})})}),it("should return seed (custom message)",function(){return __awaiter(_this,void 0,void 0,function(){var t,r;return __generator(this,function(e){switch(e.label){case 0:return[4,u.accounts];case 1:return t=e.sent()[1],[4,S.getSubAccountSeed(t,"custom message")];case 2:return r=e.sent(),chai_1.expect(r).to.be.equal("7822e8dccb866bb13f2fd52002ee2e570399caf5128c4e05436178666979881e"),[2]}})})}),it("should return sub wallet by index",function(){return __awaiter(_this,void 0,void 0,function(){var t,r,n,s,a,c;return __generator(this,function(e){switch(e.label){case 0:return[4,u.accounts];case 1:return t=e.sent()[1],[4,S.getSubAccountSeed(t,"custom message")];case 2:return r=e.sent(),n=S.getSubAccountAtIndex(r,0),chai_1.expect(n.address).to.be.equal("0xB27F6a4D60C675dE481ddb9918ee5AA5583918d3"),s=S.getSubAccountAtIndex(r,2),chai_1.expect(s.address).to.be.equal("0x30607d5F0A7658ec6e336f91A682a68c6Eb4584E"),a=S.getSubAccountAtIndex(r,3),chai_1.expect(a.address).to.be.equal("0x814B59Ce3BcD5B059006761a44E7ad985fB02B94"),c=S.getSubAccountAtIndex(r,4),chai_1.expect(c.address).to.be.equal("0x7192fA76ff06BbAfCABBd08659D7338a802a8B32"),[2]}})})}),it("should send non-blocking swap using sub account",function(){return __awaiter(_this,void 0,void 0,function(){var t,r,n,s,a,c,u,o,i,l,d,g,b,_,p,f,h,m,A,v,w;return __generator(this,function(e){switch(e.label){case 0:return[t=4,T.getNOCUSTBalance(E)];case 1:return e.sent().isLessThan(10*t)?(r=chai_1.expect,[4,T.getOnChainBalance(E)]):[3,4];case 2:return r.apply(void 0,[e.sent().toNumber()]).to.be.greaterThan(100),[4,T.approveAndDeposit(E,new bignumber_js_1.default(1e3),new bignumber_js_1.default(1e10),3e5,y)];case 3:e.sent(),e.label=4;case 4:return[4,T.getNOCUSTBalance(C)];case 5:return e.sent().isLessThan(10*t)?(n=chai_1.expect,[4,T.getOnChainBalance(C)]):[3,8];case 6:return n.apply(void 0,[e.sent().toNumber()]).to.be.greaterThan(100),[4,T.approveAndDeposit(C,new bignumber_js_1.default(1e3),new bignumber_js_1.default(1e10),3e5,y)];case 7:e.sent(),e.label=8;case 8:return[4,T.getNOCUSTBalance(B,N)];case 9:return e.sent().isLessThan(1e3)?(s=chai_1.expect,[4,T.getOnChainBalance(B,N)]):[3,12];case 10:return s.apply(void 0,[e.sent().toNumber()]).to.be.greaterThan(1e3),[4,T.approveAndDeposit(B,new bignumber_js_1.default(1e3),new bignumber_js_1.default(1e10),3e5,N)];case 11:e.sent(),e.label=12;case 12:return[4,util_1.sleep(14e3)];case 13:return e.sent(),[4,T.getNOCUSTBalance(E,N)];case 14:return e.sent().isLessThan(10*t)?[4,T.sendTransaction({tokenAddress:N,to:E,amount:new bignumber_js_1.default(100),from:B})]:[3,17];case 15:return e.sent(),[4,util_1.sleep(2e3)];case 16:e.sent(),e.label=17;case 17:return[4,T.getNOCUSTBalance(C,N)];case 18:return a=e.sent(),[4,T.getNOCUSTBalance(E,N)];case 19:return c=e.sent(),[4,T.getNOCUSTBalance(C,y)];case 20:return u=e.sent(),[4,T.getNOCUSTBalance(E,y)];case 21:return o=e.sent(),logging_1.Logging.log("bob LQD: "+a.toNumber()),logging_1.Logging.log("alice LQD: "+c.toNumber()),logging_1.Logging.log("bob ETH: "+u.toNumber()),logging_1.Logging.log("alice ETH: "+o.toNumber()),[4,S.getSubAccountSeed(C)];case 22:return i=e.sent(),[4,S.getSubAccountSeed(E)];case 23:l=e.sent(),b=[],_=[],f=0,e.label=24;case 24:return f<t?(logging_1.Logging.log("making bob swap "+f),[4,S.makeNonBlockingSwap({address:C,buyTokenAddress:N,sellTokenAddress:y,buyAmount:new bignumber_js_1.default("10"),sellAmount:new bignumber_js_1.default("10"),operatorApiUrl:x,contractAddress:y,customSeed:i})]):[3,27];case 25:p=e.sent(),b.push(p),e.label=26;case 26:return f++,[3,24];case 27:return[4,util_1.sleep(1e3)];case 28:return e.sent(),[4,S.swapSyncProcedure({address:C,buyTokenAddress:N,sellTokenAddress:y,seed:i,operatorApiUrl:x,contractAddress:y,forceAdmission:!1})];case 29:d=e.sent().pendingSwaps,chai_1.expect(d.length).to.be.equal(t),f=0,e.label=30;case 30:return f<t?(logging_1.Logging.log("making alice swap "+f),[4,S.makeNonBlockingSwap({address:E,buyTokenAddress:y,sellTokenAddress:N,buyAmount:new bignumber_js_1.default("10"),sellAmount:new bignumber_js_1.default("10"),operatorApiUrl:x,contractAddress:y,customSeed:l})]):[3,33];case 31:h=e.sent(),_.push(h),e.label=32;case 32:return f++,[3,30];case 33:return[4,util_1.sleep(1e3)];case 34:return e.sent(),[4,S.swapSyncProcedure({address:E,buyTokenAddress:N,sellTokenAddress:y,seed:l,operatorApiUrl:x,contractAddress:y,forceAdmission:!1})];case 35:return g=e.sent().pendingSwaps,chai_1.expect(g.length).to.be.equal(0),[4,S.swapSyncProcedure({address:C,buyTokenAddress:N,sellTokenAddress:y,seed:i,operatorApiUrl:x,contractAddress:y,forceAdmission:!1})];case 36:return d=e.sent().pendingSwaps,chai_1.expect(d.length).to.be.equal(0),[4,util_1.sleep(1e3)];case 37:return e.sent(),[4,T.getNOCUSTBalance(C,N)];case 38:return m=e.sent(),[4,T.getNOCUSTBalance(E,N)];case 39:return A=e.sent(),[4,T.getNOCUSTBalance(C,y)];case 40:return v=e.sent(),[4,T.getNOCUSTBalance(E,y)];case 41:return w=e.sent(),logging_1.Logging.log("bob LQD: "+m.toNumber()),logging_1.Logging.log("alice LQD: "+A.toNumber()),logging_1.Logging.log("bob ETH: "+v.toNumber()),logging_1.Logging.log("alice ETH: "+w.toNumber()),chai_1.expect(m.toNumber()).to.be.equal(a.toNumber()+10*t),chai_1.expect(v.toNumber()).to.be.equal(u.toNumber()-10*t),chai_1.expect(w.toNumber()).to.be.equal(o.toNumber()+10*t),chai_1.expect(A.toNumber()).to.be.equal(c.toNumber()-10*t),[2]}})})})});