"use strict";var __awaiter=this&&this.__awaiter||function(i,s,o,u){return new(o||(o=Promise))(function(e,t){function n(e){try{a(u.next(e))}catch(e){t(e)}}function r(e){try{a(u.throw(e))}catch(e){t(e)}}function a(t){t.done?e(t.value):new o(function(e){e(t.value)}).then(n,r)}a((u=u.apply(i,s||[])).next())})},__generator=this&&this.__generator||function(n,r){var a,i,s,e,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,i&&(s=2&t[0]?i.return:t[0]?i.throw||((s=i.return)&&s.call(i),0):i.next)&&!(s=s.call(i,t[1])).done)return s;switch(i=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=r.call(n,o)}catch(e){t=[6,e],i=0}finally{a=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var logging_1=require("../services/logging"),nocust_manager_1=require("../nocust-manager");require("reflect-metadata");var chai_1=require("chai");require("mocha");var chai_as_promised_1=__importDefault(require("chai-as-promised")),util_1=require("../util"),bignumber_js_1=__importDefault(require("bignumber.js"));describe("NOCUST Manager",function(){chai_1.use(chai_as_promised_1.default);var u,t,n,c=2e3,o="0x9561C133DD8580860B6b7E504bC5Aa500f0f06a7",g="0xe982E462b094850F12AF94d21D470e21bE9D0E9C",l="0x90F8bf6A479f320ead074411a4B0e7944Ea8c9C1",e=process.env.TEST_HUB_URL||"http://localhost:8123/",r=process.env.RPC_URL||"http://localhost:8545/",_="0xFFcf8FDEE72ac11b5c542428B35EEF5769C409f0",d="0x22d491Bde2303f2f43325b2108D26f1eAbA1e32b",a=util_1.getWeb3HttpProvider(r);function i(s,o){return __awaiter(this,void 0,void 0,function(){var t,n,r,a,i;return __generator(this,function(e){switch(e.label){case 0:return logging_1.Logging.log("Send deposit..."),[4,u.approveAndDeposit(s,new bignumber_js_1.default(1e3),new bignumber_js_1.default(1e10),3e5,o)];case 1:return e.sent(),[4,util_1.sleep(c)];case 2:return e.sent(),t=new bignumber_js_1.default(1),[4,u.getWithdrawalLimit(s,o)];case 3:n=e.sent(),logging_1.Logging.log("Withdrawal limit "+n.toFixed(0)),e.label=4;case 4:return n.isLessThan(t)?(logging_1.Logging.log("No enough withdrawal allowance, wait.."),[4,util_1.sleep(1e4)]):[3,7];case 5:return e.sent(),[4,u.getWithdrawalLimit(s,o)];case 6:return n=e.sent(),logging_1.Logging.log("Withdrawal allowance: "+n),[3,4];case 7:return[4,u.getBlocksToWithdrawalConfirmation(s,void 0,o)];case 8:return r=e.sent(),logging_1.Logging.log("Block to withdrawal confirmation "+r),-1!==r?[3,11]:(logging_1.Logging.log("No pending withdrawal, send withdrawal request..."),[4,u.withdrawalRequest(s,t,new bignumber_js_1.default(5e9),5e6,o)]);case 9:return e.sent(),[4,util_1.sleep(7*c)];case 10:return e.sent(),[3,12];case 11:logging_1.Logging.log("Pending withdrawal, wait for confirmation..."),e.label=12;case 12:return[4,u.getBlocksToWithdrawalConfirmation(s,void 0,o)];case 13:a=e.sent(),chai_1.expect(a).to.greaterThan(0),logging_1.Logging.log(a+" blocks to confirmation"),e.label=14;case 14:return 0<a?[4,util_1.sleep(1e4)]:[3,17];case 15:return e.sent(),[4,u.getBlocksToWithdrawalConfirmation(s,void 0,o)];case 16:return a=e.sent(),logging_1.Logging.log(a+" blocks to confirmation, wait.."),[3,14];case 17:return logging_1.Logging.log("Send withdrawal confirmation..."),[4,u.withdrawalConfirmation(s,new bignumber_js_1.default(1e10),3e5,o)];case 18:return e.sent(),[4,util_1.sleep(7*c)];case 19:return e.sent(),i=chai_1.expect,[4,u.getBlocksToWithdrawalConfirmation(s,void 0,o)];case 20:return i.apply(void 0,[e.sent(),"Block to confirmation set to -1"]).to.equal(-1),[2]}})})}u=new nocust_manager_1.NOCUSTManager({rpcApi:a,operatorApiUrl:e,contractAddress:o}),beforeEach(function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,u.registerAddress(_)];case 1:return e.sent(),[4,u.registerAddress(d)];case 2:return e.sent(),[4,u.registerAddress(_,g)];case 3:return e.sent(),[4,u.registerAddress(d,g)];case 4:return e.sent(),t&&t(),n&&n(),[4,u.subscribeToIncomingTransfer(_,function(e){return logging_1.Logging.log("Bob is receiving a transfer of  "+e.amount+" wei from "+e.wallet.address)},"all")];case 5:return t=e.sent(),[4,util_1.sleep(1e3)];case 6:return e.sent(),[4,u.subscribeToIncomingTransfer(d,function(e){return logging_1.Logging.log("Alice is receiving a transfer of  "+e.amount+" wei from "+e.wallet.address)},"all")];case 7:return n=e.sent(),[2]}})})}),it("Transfer Ether",function(){return __awaiter(_this,void 0,void 0,function(){var t,n,r,a;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),[4,n=u.sendTransaction({to:_,amount:new bignumber_js_1.default(0),from:d})];case 1:return r=e.sent(),logging_1.Logging.log("Transfer from Bob to Alice Confirmed, transaction ID: "+r),logging_1.Logging.log("Time for the transfer "+(Date.now()-t)/2+"'ms"),chai_1.expect(n).to.be.fulfilled,[4,util_1.sleep(1500)];case 2:return e.sent(),a=chai_1.expect,[4,u.getTransaction(r)];case 3:return a.apply(void 0,[e.sent().complete]).is.true,[2]}})})}),it("Get Balances",function(){return __awaiter(_this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:return[4,u.getNOCUSTBalance(d)];case 1:return t=e.sent(),logging_1.Logging.log("Liquid ether balance: "+t.toString()),[4,u.getNOCUSTBalance(_)];case 2:return n=e.sent(),logging_1.Logging.log("Liquid ether balance: "+n.toString()),chai_1.expect(t.toString()).to.be.a("string"),chai_1.expect(n.toString()).to.be.a("string"),[2]}})})}),it("Supported tokens",function(){return __awaiter(_this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,u.getSupportedTokens()];case 1:return t=e.sent(),logging_1.Logging.log("Supported tokens: "+JSON.stringify(t)),[2,chai_1.expect(util_1.isSameHexValue(t[0].tokenAddress,o)).to.be.true]}})})}),it("Deposit",function(){return __awaiter(_this,void 0,void 0,function(){var t,n,r,a,i,s;return __generator(this,function(e){switch(e.label){case 0:return t=new bignumber_js_1.default(1e3),[4,u.getNOCUSTBalance(_)];case 1:return n=e.sent(),[4,u.deposit(_,t,new bignumber_js_1.default(1e10),3e5)];case 2:return e.sent(),[4,util_1.sleep(2e4)];case 3:return e.sent(),[4,u.getNOCUSTBalance(_)];case 4:return r=e.sent(),chai_1.expect(r.toString()).to.equal(n.plus(t).toString()),[4,u.registerAddress(l,g)];case 5:return e.sent(),a=new bignumber_js_1.default(1e3),[4,u.getNOCUSTBalance(l)];case 6:return i=e.sent(),[4,u.approveAndDeposit(l,a,new bignumber_js_1.default(1e10),3e5)];case 7:return e.sent(),[4,util_1.sleep(2e4)];case 8:return e.sent(),[4,u.getNOCUSTBalance(l)];case 9:return s=e.sent(),chai_1.expect(s.toString()).to.equal(i.plus(a).toString()),[2]}})})}),it("Withdrawal Ether",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,i(_,void 0)];case 1:return e.sent(),[2]}})})}),it("Withdrawal ERC20",function(){return __awaiter(_this,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return[4,i(l,g)];case 1:return e.sent(),[2]}})})}),it("Transfer ERC20",function(){return __awaiter(_this,void 0,void 0,function(){var t,n,r,a,i,s;return __generator(this,function(e){switch(e.label){case 0:return t=Date.now(),[4,u.sendTransaction({tokenAddress:g,to:_,amount:new bignumber_js_1.default(0),from:d})];case 1:return n=e.sent(),[4,util_1.sleep(1500)];case 2:return e.sent(),[4,u.sendTransaction({tokenAddress:g,to:d,amount:new bignumber_js_1.default(0),from:_})];case 3:return r=e.sent(),a=Date.now(),[4,util_1.sleep(2e3)];case 4:return e.sent(),i=chai_1.expect,[4,u.getTransaction(n)];case 5:return i.apply(void 0,[e.sent().complete]).is.true,s=chai_1.expect,[4,u.getTransaction(r)];case 6:return s.apply(void 0,[e.sent().complete]).is.true,logging_1.Logging.log("Average time for a transfer "+(a-t)/2+"ms"),[2]}})})}),it("Swap",function(){return __awaiter(_this,void 0,void 0,function(){var t,n,r,a,i,s;return __generator(this,function(e){switch(e.label){case 0:return[4,u.registerAddress(l,g)];case 1:return e.sent(),[4,u.getNOCUSTBalance(l,g)];case 2:return e.sent().isLessThan(10)?(logging_1.Logging.log("Operator deposit some LQD..."),t=chai_1.expect,[4,u.getOnChainBalance(l,g)]):[3,7];case 3:return t.apply(void 0,[e.sent().toNumber()]).to.be.greaterThan(100),[4,u.approveAndDeposit(l,new bignumber_js_1.default(100),new bignumber_js_1.default(1e10),3e5,g)];case 4:return e.sent(),[4,util_1.sleep(2e4)];case 5:return e.sent(),n=chai_1.expect,[4,u.getNOCUSTBalance(l,g)];case 6:n.apply(void 0,[e.sent().toNumber()]).to.be.gte(100),e.label=7;case 7:return[4,u.getNOCUSTBalance(_)];case 8:return e.sent().isLessThan(5)?(logging_1.Logging.log("Bob deposit some ETH..."),r=chai_1.expect,[4,u.getOnChainBalance(_)]):[3,13];case 9:return r.apply(void 0,[e.sent().toNumber()]).to.be.greaterThan(100),[4,u.approveAndDeposit(_,new bignumber_js_1.default(100),new bignumber_js_1.default(1e10),3e5)];case 10:return e.sent(),[4,util_1.sleep(2e4)];case 11:return e.sent(),a=chai_1.expect,[4,u.getNOCUSTBalance(_)];case 12:a.apply(void 0,[e.sent().toNumber()]).to.be.gte(100),e.label=13;case 13:return[4,u.getNOCUSTBalance(_,g)];case 14:return i=e.sent(),logging_1.Logging.log("Bob place swap..."),[4,u.sendSwap(_,g,o,new bignumber_js_1.default(10),new bignumber_js_1.default(5))];case 15:return e.sent(),logging_1.Logging.log("Operator place swap..."),[4,u.sendSwap(l,o,g,new bignumber_js_1.default(5),new bignumber_js_1.default(10))];case 16:return e.sent(),[4,util_1.sleep(6e3)];case 17:return e.sent(),logging_1.Logging.log("Bob sync swaps..."),[4,u.synchronizeSwapOrders(_,o,g)];case 18:return e.sent(),logging_1.Logging.log("Operator sync swaps..."),[4,u.synchronizeSwapOrders(l,o,g)];case 19:return e.sent(),[4,util_1.sleep(c)];case 20:return e.sent(),[4,u.getNOCUSTBalance(_,g)];case 21:return s=e.sent(),chai_1.expect(s.toNumber()).to.be.equal(i.toNumber()+10),[2]}})})})});