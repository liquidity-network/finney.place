"use strict";var __awaiter=this&&this.__awaiter||function(n,s,o,c){return new(o||(o=Promise))(function(e,t){function r(e){try{i(c.next(e))}catch(e){t(e)}}function a(e){try{i(c.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new o(function(e){e(t.value)}).then(r,a)}i((c=c.apply(n,s||[])).next())})},__generator=this&&this.__generator||function(r,a){var i,n,s,e,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,n&&(s=2&t[0]?n.return:t[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,t[1])).done)return s;switch(n=0,s&&(t=[2&t[0],s.value]),t[0]){case 0:case 1:s=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,n=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(s=0<(s=o.trys).length&&s[s.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!s||t[1]>s[0]&&t[1]<s[3])){o.label=t[1];break}if(6===t[0]&&o.label<s[1]){o.label=s[1],s=t;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(t);break}s[2]&&o.ops.pop(),o.trys.pop();continue}t=a.call(r,o)}catch(e){t=[6,e],n=0}finally{i=s=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0});var active_state_model_1=require("../models/transactions/active-state.model"),bignumber_js_1=require("bignumber.js");require("reflect-metadata");var chai_1=require("chai");require("mocha");var chai_as_promised_1=__importDefault(require("chai-as-promised")),inversify_container_1=require("../inversify.container"),contract_api_service_1=require("../services/contract-api.service"),inversify_types_1=require("../inversify.types"),util_1=require("../util"),signature_model_1=require("../models/primitives/signature.model");describe("Contract API Service",function(){chai_1.use(chai_as_promised_1.default);var b,s,d="0x9561C133DD8580860B6b7E504bC5Aa500f0f06a7",h="0x90F8bf6A479f320ead074411a4B0e7944Ea8c9C1",t=process.env.RPC_URL||"http://localhost:8545/";beforeEach(function(){var e=inversify_container_1.NOCUSTClassFactory.createDefaultClassContainer(util_1.getWeb3HttpProvider(t));b=e.get(contract_api_service_1.ContractApiService),s=e.get(inversify_types_1.TYPES.EXTERNAL.WEB3_SERVICE_INTERFACE)}),it("should generate verifiable signatures",function(){return __awaiter(_this,void 0,void 0,function(){var t,r,a,i;return __generator(this,function(e){switch(e.label){case 0:return[4,s.accounts];case 1:return t=e.sent()[1],r=util_1.Web3Utils.soliditySha3({type:"string",value:"Hello, World!"}),[4,b.signRaw(r,t)];case 2:return a=e.sent(),[4,b.recoverSigningAddress(a,d)];case 3:return i=e.sent(),[2,chai_1.expect(i.toLowerCase()).to.equal(t.toLowerCase())]}})})}),it("should generate localy verifiable signatures",function(){return __awaiter(_this,void 0,void 0,function(){var t,r,a,i,n;return __generator(this,function(e){switch(e.label){case 0:return[4,s.accounts];case 1:return t=e.sent()[1],r=util_1.Web3Utils.soliditySha3({type:"string",value:"Hello, World!"}),[4,b.signRaw(r,t)];case 2:return a=e.sent(),[4,b.recoverSigningAddress(a,d,!1)];case 3:return i=e.sent(),[4,b.recoverSigningAddress(a,d,!0)];case 4:return n=e.sent(),[2,chai_1.expect(i.toLowerCase()).to.equal(n.toLowerCase())]}})})}),it("Signature generated using signInternalWithPrivateKey should be identical to signRaw",function(){return __awaiter(_this,void 0,void 0,function(){var t,r,a;return __generator(this,function(e){switch(e.label){case 0:return[4,s.accounts];case 1:return t=e.sent()[1],[4,b.signInternalWithPrivateKey("test",t,s.rpc.eth.accounts.wallet[t].privateKey)];case 2:return r=e.sent(),[4,b.signRaw("test",t)];case 3:return a=e.sent(),chai_1.expect(r.address).to.be.equal(a.address),chai_1.expect(r.checksum).to.be.equal(a.checksum),chai_1.expect(r.rsv).to.be.equal(a.rsv),[2]}})})}),it("Local activeState signature verification should be the same as on contract verification",function(){return __awaiter(_this,void 0,void 0,function(){var t,r,a,i,n,s,o,c,u,f,l,_;return __generator(this,function(e){switch(e.label){case 0:return t="0x22d491Bde2303f2f43325b2108D26f1eAbA1e32b",r=2,a=85,i="0xc94aadba02d9cf4c124fa573d7abfb24eebf0078361e93fd25b7da11369b8fe6",n=new bignumber_js_1.BigNumber(0),s=new bignumber_js_1.BigNumber(0),o=active_state_model_1.ActiveState.checksum(d,d,t,r,a,i,n,s),c=new signature_model_1.Signature(h,o,"0xad2f8aaabc45c00310750d201044b54756030296c401880d2207a2f4f453d3eb","0x40d0113fd8872b318492b3fca47b920bbfd3b02edae7659d9da56f31b5d08a95","0x1c"),[4,b.verifyProofOfTransitionAgreement(d,t,r,a,i,n,s,c,d,!0)];case 1:return u=e.sent(),[4,b.verifyProofOfTransitionAgreement(d,t,r,a,i,n,s,c,d,!1)];case 2:return f=e.sent(),chai_1.expect(u).to.equal(f),l=new signature_model_1.Signature(h,o,"0xad2f8aaabc45c00310750d201044b54756030296c401880d2207a2f4f453d3eb","0x0000013fd8872b318492b3fca47b920bbfd3b02edae7659d9da56f31b5d08a95","0x1c"),_=b.verifyProofOfTransitionAgreement(d,t,r,a,i,n,s,l,d,!0),[2,chai_1.expect(_).to.rejected]}})})}),it("Local verification of proof of membership should be the same as on the contract",function(){return __awaiter(_this,void 0,void 0,function(){var t,r,a,i,n,s,o,c,u;return __generator(this,function(e){switch(e.label){case 0:return t=2,r=[],a="0x22d491Bde2303f2f43325b2108D26f1eAbA1e32b",i=new bignumber_js_1.BigNumber(0),n=1,s=new bignumber_js_1.BigNumber("930500683"),o="1b20775cab3d7d3aa2340e24921c53aa27e3f1ba556e656defaf7b1cc3188b62",c=chai_1.expect,[4,b.verifyProofOfTransferAggregationRaw(t,r,a,i,n,s,o,d,!0,new bignumber_js_1.BigNumber(0),!1)];case 1:return c.apply(void 0,[e.sent()]).to.be.true,u=chai_1.expect,[4,b.verifyProofOfTransferAggregationRaw(t,r,a,i,n,s,o,d,!0,new bignumber_js_1.BigNumber(0),!0)];case 2:return u.apply(void 0,[e.sent()]).to.be.true,[2]}})})})});