"use strict";var __awaiter=this&&this.__awaiter||function(i,c,o,l){return new(o||(o=Promise))(function(e,t){function r(e){try{n(l.next(e))}catch(e){t(e)}}function a(e){try{n(l.throw(e))}catch(e){t(e)}}function n(t){t.done?e(t.value):new o(function(e){e(t.value)}).then(r,a)}n((l=l.apply(i,c||[])).next())})},__generator=this&&this.__generator||function(r,a){var n,i,c,e,o={label:0,sent:function(){if(1&c[0])throw c[1];return c[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,i&&(c=2&t[0]?i.return:t[0]?i.throw||((c=i.return)&&c.call(i),0):i.next)&&!(c=c.call(i,t[1])).done)return c;switch(i=0,c&&(t=[2&t[0],c.value]),t[0]){case 0:case 1:c=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,i=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(c=0<(c=o.trys).length&&c[c.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!c||t[1]>c[0]&&t[1]<c[3])){o.label=t[1];break}if(6===t[0]&&o.label<c[1]){o.label=c[1],c=t;break}if(c&&o.label<c[2]){o.label=c[2],o.ops.push(t);break}c[2]&&o.ops.pop(),o.trys.pop();continue}t=a.call(r,o)}catch(e){t=[6,e],i=0}finally{n=c=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}},_this=this;Object.defineProperty(exports,"__esModule",{value:!0}),require("reflect-metadata");var chai_1=require("chai");require("mocha");var chai_as_promised_1=__importDefault(require("chai-as-promised")),wallet_state_service_1=require("../services/wallet-state.service"),inversify_container_1=require("../inversify.container"),inversify_types_1=require("../inversify.types"),wallet_model_1=require("../models/wallet/wallet.model"),operator_state_service_1=require("../services/operator-state.service"),contract_state_service_1=require("../services/contract-state.service"),wallet_update_error_model_1=require("../models/state/wallet-update-error.model"),wallet_sync_state_model_1=require("../models/state/wallet-sync-state.model"),logging_1=require("../services/logging"),util_1=require("../util"),contract_api_service_1=require("../services/contract-api.service"),operator_api_service_1=require("../services/operator-api.service");describe("Wallet State Service",function(){chai_1.use(chai_as_promised_1.default);var c,o,l,s,_="0x9561C133DD8580860B6b7E504bC5Aa500f0f06a7",u=process.env.TEST_HUB_URL||"http://localhost/",t=process.env.RPC_URL||"http://localhost:8545/";beforeEach(function(){var e=inversify_container_1.NOCUSTClassFactory.createDefaultClassContainer(util_1.getWeb3HttpProvider(t));c=e.get(inversify_types_1.TYPES.EXTERNAL.WEB3_SERVICE_INTERFACE),o=e.get(operator_state_service_1.OperatorStateService),e.get(contract_api_service_1.ContractApiService),l=e.get(contract_state_service_1.ContractStateService),e.get(operator_api_service_1.OperatorApiService),s=e.get(wallet_state_service_1.WalletStateService)}),it("should return a WalletState object for a registered wallet",function(){return __awaiter(_this,void 0,void 0,function(){var t,r,a,n,i;return __generator(this,function(e){switch(e.label){case 0:return[4,c.accounts];case 1:return t=e.sent()[0],r=new wallet_model_1.Wallet(t,1337,t,_,_,u),[4,o.fetchOperatorState(r)];case 2:return a=e.sent(),[4,l.fetchContractState(r)];case 3:return n=e.sent(),[4,s.syncWalletState(r,n,a)];case 4:return(i=e.sent()).syncState!=wallet_sync_state_model_1.WalletSyncState.SYNCHRONIZED&&logging_1.Logging.error(i.updateError),[2,i.syncState==wallet_sync_state_model_1.WalletSyncState.SYNCHRONIZED]}})})}),it("should be unsafe for unregistered wallets",function(){return __awaiter(_this,void 0,void 0,function(){var r,t,a,n;return __generator(this,function(e){switch(e.label){case 0:return"0x9fa2a0d524c91f7f243b17461c1c64bca49282cb",t=wallet_model_1.Wallet.bind,a=[void 0,"0x9fa2a0d524c91f7f243b17461c1c64bca49282cb",1337],[4,c.accounts];case 1:return r=new(t.apply(wallet_model_1.Wallet,a.concat([e.sent()[0],_,_,u]))),n=o.fetchOperatorState(r).then(function(t){return l.fetchContractState(r).then(function(e){return s.syncWalletState(r,e,t)})}),[2,chai_1.expect(n).to.eventually.satisfy(function(e){return e.syncState==wallet_sync_state_model_1.WalletSyncState.UNSAFE&&e.updateError==wallet_update_error_model_1.WalletUpdateError.UNREGISTERED_NO_REQUEST})]}})})})});